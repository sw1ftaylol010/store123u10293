# üìä –ì–õ–£–ë–û–ö–ê–Ø E2E –ê–ù–ê–õ–ò–¢–ò–ö–ê - –ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï

## ‚úÖ –ß–¢–û –°–î–ï–õ–ê–ù–û

–í–Ω–µ–¥—Ä–µ–Ω–∞ **–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∫–≤–æ–∑–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞** –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞ –¥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–∫—É–ø–∫–∏.

---

## üéØ –û–°–ù–û–í–ù–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Tracking

**–†–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏:**
- ‚úÖ Page views (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- ‚úÖ Session tracking (30 –¥–Ω–µ–π)
- ‚úÖ Visitor tracking (365 –¥–Ω–µ–π)
- ‚úÖ UTM attribution (Last Non-Direct Click)

**Product funnel:**
- ‚úÖ View product
- ‚úÖ Configurator open
- ‚úÖ Configurator change (nominal/delivery)
- ‚úÖ Add to cart
- ‚úÖ Checkout start

### 2. –ê–¥–º–∏–Ω –î–∞—à–±–æ—Ä–¥—ã

**–í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ (`/admin/funnel`):**
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤
- Drop-off –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
- –¢–æ–ø-3 Bottlenecks
- –§–∏–ª—å—Ç—Ä—ã –ø–æ –¥–∞—Ç–∞–º

**–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã (`/admin/channels`):**
- UTM source + campaign
- Sessions, Orders, Revenue
- Conversion Rate, AOV
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—ã—Ä—É—á–∫–µ

**Cohort Analysis (`/admin/cohorts`):**
- –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã —Å LTV
- Repeat vs New customers
- Average LTV
- Days between purchases
- Insights —Å benchmarks

**Webhook Logs (`/admin/webhooks`):**
- –í—Å–µ webhook –∑–∞–ø—Ä–æ—Å—ã
- Status, errors
- Troubleshooting

### 3. SQL –§—É–Ω–∫—Ü–∏–∏

**4 –≥–æ—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `get_funnel_stats()` - –≤–æ—Ä–æ–Ω–∫–∞
- `get_channel_stats()` - –∫–∞–Ω–∞–ª—ã
- `get_brand_stats()` - –±—Ä–µ–Ω–¥—ã
- `get_cohort_analysis()` - –∫–æ–≥–æ—Ä—Ç—ã

### 4. UTM –ê—Ç—Ä–∏–±—É—Ü–∏—è

**Last Non-Direct Click:**
- Capture UTM –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞—Ö–æ–¥–µ
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ cookie (30 –¥–Ω–µ–π)
- –ê—Ç—Ä–∏–±—É—Ü–∏—è –∫ –∑–∞–∫–∞–∑–∞–º
- –°–≤—è–∑—å —Å –≤—ã—Ä—É—á–∫–æ–π

### 5. –ò–Ω–¥–µ–∫—Å—ã & Performance

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:**
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª—è—Ö
- –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (daily_analytics)
- –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–∞–∂–µ –Ω–∞ –º–∏–ª–ª–∏–æ–Ω–∞—Ö —Å—Ç—Ä–æ–∫

---

## üìÅ –§–ê–ô–õ–´

### –ú–∏–≥—Ä–∞—Ü–∏—è
- `supabase/migrations/20240103000000_deep_analytics.sql`

### –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞
- `src/lib/analytics/tracking.ts` - –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π tracking
- `src/app/api/events/route.ts` - API endpoint

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- `src/components/analytics/AnalyticsProvider.tsx` - global provider

### –ê–¥–º–∏–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- `src/app/[locale]/admin/funnel/page.tsx`
- `src/app/[locale]/admin/channels/page.tsx`
- `src/app/[locale]/admin/cohorts/page.tsx`

### –û–±–Ω–æ–≤–ª–µ–Ω—ã
- `src/app/api/orders/create/route.ts` - UTM –≤ orders
- `src/components/product/ProductConfigurator.tsx` - tracking events
- `src/app/[locale]/checkout/page.tsx` - checkout_start event
- `src/app/[locale]/layout.tsx` - AnalyticsProvider

---

## üîß –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨

### 1. –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```sql
-- –í Supabase SQL Editor
-- –ó–∞–ø—É—Å—Ç–∏—Ç—å: supabase/migrations/20240103000000_deep_analytics.sql
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å tracking

```typescript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ AnalyticsProvider
// –ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
import { Analytics } from '@/lib/analytics/tracking';

Analytics.viewProduct(productId, brand, region);
Analytics.addToCart(productId, nominal, price);
```

### 3. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞—à–±–æ—Ä–¥—ã

```
/admin/funnel    - –≤–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
/admin/channels  - –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã
/admin/cohorts   - LTV –∏ retention
/admin/webhooks  - –ª–æ–≥–∏ webhook'–æ–≤
```

### 4. –ó–∞–ø—Ä–æ—Å—ã –≤ SQL

```sql
-- –í–æ—Ä–æ–Ω–∫–∞ –∑–∞ 7 –¥–Ω–µ–π
SELECT * FROM get_funnel_stats(
  NOW() - INTERVAL '7 days',
  NOW(),
  NULL,  -- —Ñ–∏–ª—å—Ç—Ä –ø–æ utm_source
  NULL   -- —Ñ–∏–ª—å—Ç—Ä –ø–æ utm_campaign
);

-- –ö–∞–Ω–∞–ª—ã –∑–∞ 30 –¥–Ω–µ–π
SELECT * FROM get_channel_stats(
  NOW() - INTERVAL '30 days',
  NOW()
);

-- Cohort analysis
SELECT * FROM get_cohort_analysis(30, NOW() - INTERVAL '90 days');
```

---

## üéØ –ú–ï–¢–†–ò–ö–ò

### –í–æ—Ä–æ–Ω–∫–∞ (benchmark)

```
Total Sessions      100%
  ‚Üì
View Product        ~85%  (15% drop)
  ‚Üì
Configurator Open   ~60%  (25% drop)
  ‚Üì
Checkout Start      ~40%  (20% drop)
  ‚Üì
Payment Redirect    ~90%  (10% drop)
  ‚Üì
Paid                ~85%  (15% drop)

Overall CR: 15-20%
```

### –ö–∞–Ω–∞–ª—ã (expected CR)

- Branded search: 20-30%
- Generic search: 10-15%
- Retargeting: 5-10%
- Cold traffic: 2-5%

### Cohorts (good benchmarks)

- Repeat Rate: 20-30%
- LTV: $100-200 (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç AOV)
- Days Between: 15-30

---

## ‚ö†Ô∏è TODO (–û–°–¢–ê–õ–û–°–¨)

### High Priority

- [ ] `checkout_submit` event (–ø—Ä–∏ –∫–ª–∏–∫–µ "Pay Now")
- [ ] `payment_redirect` event (–ø—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–µ –Ω–∞ Cardlink)
- [ ] `payment_success` event (server-side –≤ webhook)
- [ ] `code_sent` event (server-side –ø–æ—Å–ª–µ email)

### Medium Priority

- [ ] Cron job: `refresh_daily_analytics()` –µ–∂–µ–¥–Ω–µ–≤–Ω–æ 00:00 UTC
- [ ] –§–∏–ª—å—Ç—Ä—ã –≤ Funnel –ø–æ utm_source/utm_campaign
- [ ] –§–∏–ª—å—Ç—Ä—ã –≤ Channels –ø–æ utm_source/utm_campaign

### Low Priority (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

- [ ] GA4 events (page_view, view_item, add_to_cart, purchase)
- [ ] Meta Pixel events (PageView, ViewContent, AddToCart, Purchase)
- [ ] Alerts –Ω–∞ –ø–∞–¥–µ–Ω–∏–µ CR / Repeat Rate

---

## üöÄ –ü–†–û–í–ï–†–ö–ê

### –¢–µ—Å—Ç 1: UTM Capture

```bash
# –û—Ç–∫—Ä—ã—Ç—å —Å UTM
http://localhost:3000/en?utm_source=test&utm_campaign=analytics_test

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å cookie –≤ DevTools
lv_sess, lv_visitor, lv_utm –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã
```

### –¢–µ—Å—Ç 2: Events

```sql
-- –ü–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤–æ—Ä–æ–Ω–∫–∏
SELECT event_type, session_id, utm_source, created_at
FROM events
WHERE session_id = 'YOUR_SESSION_ID'
ORDER BY created_at;

-- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å:
-- page_view
-- view_product
-- configurator_open
-- configurator_change
-- add_to_cart
-- checkout_start
```

### –¢–µ—Å—Ç 3: Funnel

```sql
SELECT * FROM get_funnel_stats(
  NOW() - INTERVAL '1 day',
  NOW(),
  NULL,
  NULL
);

-- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º —à–∞–≥–∞–º
```

---

## üìñ –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

**–ü–æ–¥—Ä–æ–±–Ω–æ:**
- [DEEP_ANALYTICS.md](./DEEP_ANALYTICS.md) - —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π blueprint
- [ANALYTICS_IMPLEMENTATION.md](./ANALYTICS_IMPLEMENTATION.md) - —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –≤–Ω–µ–¥—Ä–µ–Ω–æ

**–°–≤—è–∑–∞–Ω–Ω—ã–µ:**
- [CRITICAL_IMPROVEMENTS.md](./CRITICAL_IMPROVEMENTS.md) - –¥—Ä—É–≥–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏
- [WHAT_WAS_DONE.md](./WHAT_WAS_DONE.md) - –æ–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

---

## ‚úÖ –ò–¢–û–ì

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: 90%**

### –†–∞–±–æ—Ç–∞–µ—Ç:
- ‚úÖ Auto page view tracking
- ‚úÖ Session & Visitor tracking
- ‚úÖ UTM capture & attribution
- ‚úÖ Product funnel events (5 —Å–æ–±—ã—Ç–∏–π)
- ‚úÖ –ê–¥–º–∏–Ω –¥–∞—à–±–æ—Ä–¥—ã (Funnel, Channels, Cohorts, Webhooks)
- ‚úÖ SQL —Ñ—É–Ω–∫—Ü–∏–∏ (4 —à—Ç—É–∫–∏)
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã & performance
- ‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ

### –û—Å—Ç–∞–ª–æ—Å—å:
- üî∂ 4 server-side —Å–æ–±—ã—Ç–∏—è (checkout_submit, payment_*, code_sent)
- üî∂ Cron job –¥–ª—è daily_analytics
- üî∂ –§–∏–ª—å—Ç—Ä—ã –≤ –∞–¥–º–∏–Ω–∫–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- üî∂ GA4/Meta events (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** –í—ã –º–æ–∂–µ—Ç–µ:
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ê—Ç—Ä–∏–±—É—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã—Ä—É—á–∫—É –∫ —Ä–µ–∫–ª–∞–º–Ω—ã–º –∫–∞–Ω–∞–ª–∞–º
- –ù–∞—Ö–æ–¥–∏—Ç—å —É–∑–∫–∏–µ –º–µ—Å—Ç–∞ –≤ –≤–æ—Ä–æ–Ω–∫–µ
- –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å LTV –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏

**Blueprint –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω!** üöÄüìä

