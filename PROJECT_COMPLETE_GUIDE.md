# üìö LONIEVE GIFT - –ü–û–õ–ù–û–ï –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –†–£–ö–û–í–û–î–°–¢–í–û

## üéØ –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
2. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã)](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
3. [SQL —Ñ—É–Ω–∫—Ü–∏–∏ (–≤—Å–µ 20+)](#sql-—Ñ—É–Ω–∫—Ü–∏–∏)
4. [API endpoints (–≤—Å–µ 30+)](#api-endpoints)
5. [–ê–¥–º–∏–Ω –¥–∞—à–±–æ—Ä–¥—ã (–≤—Å–µ 19)](#–∞–¥–º–∏–Ω-–¥–∞—à–±–æ—Ä–¥—ã)
6. [–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–ø–æ–ª–Ω—ã–π flow)](#–∞–Ω–∞–ª–∏—Ç–∏–∫–∞)
7. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
8. [Deployment](#deployment)
9. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã)

---

## üìê –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê

### –û–±—â–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FRONTEND (Next.js 14)                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ   Customer   ‚îÇ  ‚îÇ    Admin     ‚îÇ  ‚îÇ      AI      ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ   Storefront ‚îÇ  ‚îÇ   Dashboard  ‚îÇ  ‚îÇ    Copilot   ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                  ‚îÇ                  ‚îÇ
          ‚ñº                  ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     API LAYER (Next.js)                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ   E-commerce ‚îÇ  ‚îÇ   Analytics  ‚îÇ  ‚îÇ  AI Copilot  ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ   /api/...   ‚îÇ  ‚îÇ  /api/events ‚îÇ  ‚îÇ/api/ai/...   ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                  ‚îÇ                  ‚îÇ
          ‚ñº                  ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    SUPABASE (Backend)                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ  PostgreSQL  ‚îÇ  ‚îÇ     Auth     ‚îÇ  ‚îÇ     Edge     ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ  (40 tables) ‚îÇ  ‚îÇ     (RLS)    ‚îÇ  ‚îÇ  Functions   ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                  ‚îÇ                  ‚îÇ
          ‚ñº                  ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    EXTERNAL SERVICES                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ   Cardlink   ‚îÇ  ‚îÇ  GA4 + Meta  ‚îÇ  ‚îÇ   Telegram   ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ  (Payments)  ‚îÇ  ‚îÇ  (Analytics) ‚îÇ  ‚îÇ     Bot      ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Tech Stack (–¥–µ—Ç–∞–ª—å–Ω–æ)

**Frontend:**
- Next.js 14.0+ (App Router)
- React 18+ (Server/Client Components)
- TypeScript 5.0+
- Tailwind CSS 3.4+

**Backend:**
- Supabase (PostgreSQL 15+)
- Supabase Auth (JWT)
- Supabase Edge Functions (Deno)

**Payment:**
- Cardlink API v2
- Webhook processing
- Idempotency

**Analytics:**
- GA4 (gtag.js)
- Meta Pixel
- Custom events table

**Deployment:**
- Vercel (Frontend)
- Supabase (Backend)
- Cloudflare DNS (optional)

---

## üóÑÔ∏è –ë–ê–ó–ê –î–ê–ù–ù–´–• (–í–°–ï 40+ –¢–ê–ë–õ–ò–¶)

### 1. CORE E-COMMERCE TABLES

#### `products` - –ü—Ä–æ–¥—É–∫—Ç—ã (gift cards)

```sql
CREATE TABLE products (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,                    -- "Amazon Gift Card"
    brand TEXT NOT NULL,                   -- "Amazon"
    region TEXT NOT NULL,                  -- "USA", "EUR", "Global"
    category TEXT,                         -- "Gaming", "Shopping", "Entertainment"
    description TEXT,
    image_url TEXT,
    nominals JSONB NOT NULL,               -- [50, 100, 200, 500]
    base_price NUMERIC(10,2) NOT NULL,     -- –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞
    discount_percentage NUMERIC(5,2) DEFAULT 0, -- –°–∫–∏–¥–∫–∞ (0-100%)
    currency TEXT DEFAULT 'USD',
    status TEXT DEFAULT 'active',          -- 'active', 'inactive', 'out_of_stock'
    delivery_time TEXT DEFAULT 'instant',  -- "instant", "1-24h"
    terms_conditions TEXT,
    features JSONB,                        -- –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_products_brand ON products(brand);
CREATE INDEX idx_products_region ON products(region);
CREATE INDEX idx_products_status ON products(status);
CREATE INDEX idx_products_sort ON products(sort_order);

-- –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:
{
  "id": "uuid-1",
  "name": "Amazon Gift Card",
  "brand": "Amazon",
  "region": "USA",
  "nominals": [25, 50, 100, 200, 500],
  "base_price": 100.00,
  "discount_percentage": 25.00,  -- 25% —Å–∫–∏–¥–∫–∞
  "currency": "USD",
  "status": "active"
}

-- –†–∞—Å—á—ë—Ç –∏—Ç–æ–≥–æ–≤–æ–π —Ü–µ–Ω—ã:
final_price = base_price * (1 - discount_percentage / 100)
-- –ü—Ä–∏–º–µ—Ä: 100 * (1 - 25/100) = 75 USD
```

#### `gift_codes` - Gift card –∫–æ–¥—ã

```sql
CREATE TABLE gift_codes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID REFERENCES products(id) ON DELETE CASCADE,
    code TEXT NOT NULL UNIQUE,             -- –°–∞–º –∫–æ–¥ (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π)
    nominal NUMERIC(10,2) NOT NULL,        -- –ù–æ–º–∏–Ω–∞–ª ($50, $100)
    cost_price NUMERIC(10,2),              -- –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–¥–ª—è profit)
    margin_percentage NUMERIC(5,2),        -- –ú–∞—Ä–∂–∞ %
    currency TEXT DEFAULT 'USD',
    status TEXT DEFAULT 'available',       -- 'available', 'sold', 'reserved'
    order_item_id UUID REFERENCES order_items(id),
    sold_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,
    batch_id TEXT,                         -- ID –ø–∞—Ä—Ç–∏–∏ –∏–º–ø–æ—Ä—Ç–∞
    imported_at TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏!)
CREATE INDEX idx_codes_product ON gift_codes(product_id);
CREATE INDEX idx_codes_status ON gift_codes(status);
CREATE INDEX idx_codes_nominal ON gift_codes(nominal);
CREATE INDEX idx_codes_available ON gift_codes(product_id, nominal, status) 
    WHERE status = 'available';  -- Partial index –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

-- –ü—Ä–∏–º–µ—Ä:
{
  "id": "uuid-code-1",
  "product_id": "uuid-1",
  "code": "XXXX-XXXX-XXXX-XXXX",  -- –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ!
  "nominal": 100.00,
  "cost_price": 75.00,            -- –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
  "margin_percentage": 25.00,     -- –ú–∞—Ä–∂–∞
  "status": "available"
}

-- –í–∞–∂–Ω–æ: –∫–æ–¥ —à–∏—Ñ—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ –ë–î!
```

#### `orders` - –ó–∞–∫–∞–∑—ã

```sql
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Customer info
    email TEXT NOT NULL,
    first_name TEXT,
    last_name TEXT,
    user_id UUID REFERENCES auth.users(id),
    
    -- Order details
    total_amount NUMERIC(10,2) NOT NULL,
    total_cost NUMERIC(10,2),              -- –°—É–º–º–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
    total_profit NUMERIC(10,2),            -- Profit (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
    currency TEXT DEFAULT 'USD',
    status TEXT DEFAULT 'pending',         -- 'pending', 'paid', 'failed', 'manual_review'
    
    -- Financial (Unit Economics)
    transaction_fees NUMERIC(10,2) DEFAULT 0,
    refund_amount NUMERIC(10,2) DEFAULT 0,
    true_profit NUMERIC(10,2),             -- Revenue - Cost - Fees - Refunds
    
    -- Payment
    payment_method TEXT DEFAULT 'cardlink',
    cardlink_bill_id TEXT,
    payment_url TEXT,
    
    -- Email delivery
    email_status TEXT DEFAULT 'pending',   -- 'pending', 'sent', 'failed'
    email_sent_at TIMESTAMPTZ,
    email_retry_count INTEGER DEFAULT 0,
    
    -- Analytics & Attribution
    session_id TEXT,                       -- Session tracking
    visitor_id TEXT,                       -- Long-term visitor ID
    utm_source TEXT,                       -- 'facebook', 'google'
    utm_medium TEXT,                       -- 'cpc', 'organic'
    utm_campaign TEXT,                     -- Campaign name
    utm_content TEXT,                      -- Ad creative
    utm_term TEXT,                         -- Keywords
    referrer TEXT,                         -- HTTP referrer
    ip_address TEXT,
    user_agent TEXT,
    device_type TEXT,                      -- 'mobile', 'desktop'
    country TEXT,
    city TEXT,
    
    -- Multi-tenant
    tenant_id UUID REFERENCES tenants(id),
    
    -- Partner/Affiliate
    affiliate_link_id UUID REFERENCES affiliate_links(id),
    partner_id UUID REFERENCES partner_accounts(id),
    partner_commission NUMERIC(10,2),
    
    -- Delivery
    delivery_type TEXT DEFAULT 'myself',   -- 'myself', 'gift'
    recipient_email TEXT,
    gift_message TEXT,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    paid_at TIMESTAMPTZ
);

-- Indexes (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û!)
CREATE INDEX idx_orders_email ON orders(email);
CREATE INDEX idx_orders_user ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_session ON orders(session_id);
CREATE INDEX idx_orders_created ON orders(created_at DESC);
CREATE INDEX idx_orders_utm ON orders(utm_source, utm_campaign);
CREATE INDEX idx_orders_partner ON orders(partner_id);
CREATE INDEX idx_orders_tenant ON orders(tenant_id);

-- Composite index –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
CREATE INDEX idx_orders_analytics ON orders(status, created_at, utm_source);

-- –ü—Ä–∏–º–µ—Ä –∑–∞–∫–∞–∑–∞:
{
  "id": "order-uuid-1",
  "email": "customer@example.com",
  "total_amount": 75.00,
  "total_cost": 56.25,
  "total_profit": 18.75,
  "status": "paid",
  "session_id": "sess_abc123",
  "utm_source": "facebook",
  "utm_campaign": "black_friday",
  "created_at": "2025-01-15T10:30:00Z"
}
```

#### `order_items` - –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞

```sql
CREATE TABLE order_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
    product_id UUID REFERENCES products(id),
    gift_code_id UUID REFERENCES gift_codes(id),
    
    product_name TEXT NOT NULL,
    product_brand TEXT,
    nominal NUMERIC(10,2) NOT NULL,
    price NUMERIC(10,2) NOT NULL,          -- –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏
    cost_price NUMERIC(10,2),              -- –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
    profit NUMERIC(10,2),                  -- price - cost_price
    margin_percentage NUMERIC(5,2),        -- (profit / price) * 100
    
    quantity INTEGER DEFAULT 1,
    currency TEXT DEFAULT 'USD',
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_order_items_order ON order_items(order_id);
CREATE INDEX idx_order_items_product ON order_items(product_id);
CREATE INDEX idx_order_items_code ON order_items(gift_code_id);
```

#### `payments` - –ü–ª–∞—Ç–µ–∂–∏

```sql
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
    
    bill_id TEXT UNIQUE NOT NULL,          -- Cardlink bill ID
    status TEXT DEFAULT 'pending',         -- 'pending', 'paid', 'failed', 'expired'
    amount NUMERIC(10,2) NOT NULL,
    currency TEXT DEFAULT 'USD',
    
    payment_method TEXT,
    payment_url TEXT,
    
    -- Webhook processing
    processed_at TIMESTAMPTZ,
    idempotency_key TEXT UNIQUE,           -- –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π
    
    -- Cardlink data
    cardlink_response JSONB,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_payments_order ON payments(order_id);
CREATE INDEX idx_payments_bill ON payments(bill_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_idempotency ON payments(idempotency_key);
```

### 2. ANALYTICS TABLES

#### `events` - –°–æ–±—ã—Ç–∏—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

```sql
CREATE TABLE events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Event info
    event_type TEXT NOT NULL,              -- 'page_view', 'add_to_cart', etc
    
    -- Session tracking
    session_id TEXT NOT NULL,              -- 30-day session
    user_id UUID,                          -- –ï—Å–ª–∏ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
    visitor_id TEXT,                       -- 365-day visitor ID
    
    -- Page context
    url TEXT,
    referrer TEXT,
    
    -- UTM parameters (Last Non-Direct Click)
    utm_source TEXT,
    utm_medium TEXT,
    utm_campaign TEXT,
    utm_content TEXT,
    utm_term TEXT,
    
    -- Event data (flexible)
    data JSONB,
    
    -- Behavioral
    session_duration INTEGER,              -- –°–µ–∫—É–Ω–¥—ã
    page_duration INTEGER,                 -- –°–µ–∫—É–Ω–¥—ã
    scroll_depth INTEGER,                  -- 0-100%
    
    -- Device & Location
    device_type TEXT,                      -- 'mobile', 'tablet', 'desktop'
    country TEXT,
    city TEXT,
    
    -- Technical
    ip_address TEXT,
    user_agent TEXT,
    
    -- Multi-tenant
    tenant_id UUID REFERENCES tenants(id)
);

-- Indexes (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏!)
CREATE INDEX idx_events_session ON events(session_id);
CREATE INDEX idx_events_visitor ON events(visitor_id);
CREATE INDEX idx_events_type ON events(event_type);
CREATE INDEX idx_events_created ON events(created_at DESC);
CREATE INDEX idx_events_utm ON events(utm_source, utm_campaign);

-- Composite indexes –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx_events_funnel ON events(session_id, event_type, created_at);
CREATE INDEX idx_events_analytics ON events(event_type, created_at, utm_source);

-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π:
/*
Navigation:
  - page_view
  - view_catalog
  - view_product

Funnel:
  - configurator_open
  - configurator_change
  - add_to_cart
  - checkout_start
  - checkout_submit
  - payment_redirect
  - payment_return
  - payment_success
  - code_sent

Support:
  - support_open
  - support_request
  - resend_email_request
  - account_login
*/

-- –ü—Ä–∏–º–µ—Ä —Å–æ–±—ã—Ç–∏—è:
{
  "event_type": "add_to_cart",
  "session_id": "sess_abc123",
  "visitor_id": "visitor_xyz",
  "utm_source": "facebook",
  "utm_campaign": "black_friday",
  "data": {
    "product_id": "uuid-1",
    "nominal": 100,
    "price": 75
  },
  "device_type": "mobile",
  "created_at": "2025-01-15T10:35:00Z"
}
```

#### `daily_metrics` - –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ

```sql
CREATE MATERIALIZED VIEW daily_metrics AS
SELECT
  DATE(o.created_at) AS date,
  o.tenant_id,
  o.utm_source,
  o.utm_campaign,
  
  -- Sessions & Orders
  COUNT(DISTINCT o.session_id) AS sessions,
  COUNT(o.id) AS total_orders,
  COUNT(o.id) FILTER (WHERE o.status = 'paid') AS paid_orders,
  
  -- Revenue & Profit
  SUM(o.total_amount) FILTER (WHERE o.status = 'paid') AS revenue,
  SUM(o.total_cost) FILTER (WHERE o.status = 'paid') AS cost,
  SUM(o.total_profit) FILTER (WHERE o.status = 'paid') AS profit,
  
  -- Conversion metrics
  ROUND((COUNT(o.id) FILTER (WHERE o.status = 'paid')::NUMERIC / 
         NULLIF(COUNT(DISTINCT o.session_id), 0) * 100), 2) AS conversion_rate,
  ROUND(AVG(o.total_amount) FILTER (WHERE o.status = 'paid'), 2) AS avg_order_value,
  
  -- Margin
  CASE 
    WHEN SUM(o.total_amount) FILTER (WHERE o.status = 'paid') > 0 
    THEN ROUND((SUM(o.total_profit) FILTER (WHERE o.status = 'paid') / 
                SUM(o.total_amount) FILTER (WHERE o.status = 'paid') * 100), 2)
    ELSE 0 
  END AS margin_percentage
FROM orders o
GROUP BY DATE(o.created_at), o.tenant_id, o.utm_source, o.utm_campaign;

-- Unique index –¥–ª—è CONCURRENTLY refresh
CREATE UNIQUE INDEX idx_daily_metrics_unique 
ON daily_metrics (date, COALESCE(tenant_id::text, ''), 
                  COALESCE(utm_source, ''), COALESCE(utm_campaign, ''));

-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—á–µ—Ä–µ–∑ cron job):
REFRESH MATERIALIZED VIEW CONCURRENTLY daily_metrics;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
SELECT * FROM daily_metrics 
WHERE date >= CURRENT_DATE - INTERVAL '30 days'
ORDER BY date DESC;
```

### 3. BUSINESS INTELLIGENCE TABLES

#### `email_templates` - –®–∞–±–ª–æ–Ω—ã email –∫–∞–º–ø–∞–Ω–∏–π

```sql
CREATE TABLE email_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    type TEXT NOT NULL,                    -- 'abandoned_cart', 'winback', 'vip_offer'
    name TEXT NOT NULL,
    subject TEXT NOT NULL,
    html_body TEXT NOT NULL,
    text_body TEXT,
    variables JSONB,                       -- –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ü—Ä–∏–º–µ—Ä —à–∞–±–ª–æ–Ω–∞:
{
  "type": "abandoned_cart",
  "name": "Abandoned Cart Recovery",
  "subject": "You left something behind! üõí",
  "html_body": "<html><body>Hi {{name}}, complete your purchase of {{product}} and get 10% off! <a href='{{checkout_link}}'>Complete Now</a></body></html>",
  "variables": {
    "name": "string",
    "product": "string",
    "checkout_link": "string"
  }
}
```

#### `campaign_logs` - –õ–æ–≥–∏ email –∫–∞–º–ø–∞–Ω–∏–π

```sql
CREATE TABLE campaign_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_type TEXT NOT NULL,
    template_id UUID REFERENCES email_templates(id),
    
    recipient_email TEXT NOT NULL,
    recipient_user_id UUID,
    subject TEXT NOT NULL,
    
    -- Tracking
    sent_at TIMESTAMPTZ DEFAULT NOW(),
    opened_at TIMESTAMPTZ,                 -- –ö–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–ª–∏
    clicked_at TIMESTAMPTZ,                -- –ö–æ–≥–¥–∞ –∫–ª–∏–∫–Ω—É–ª–∏
    converted_at TIMESTAMPTZ,              -- –ö–æ–≥–¥–∞ –∫—É–ø–∏–ª–∏
    
    -- Conversion (7-day attribution)
    conversion_order_id UUID REFERENCES orders(id),
    conversion_amount NUMERIC,
    
    status TEXT DEFAULT 'sent',            -- 'sent', 'opened', 'clicked', 'converted', 'failed'
    error_message TEXT,
    metadata JSONB
);

CREATE INDEX idx_campaign_logs_email ON campaign_logs(recipient_email);
CREATE INDEX idx_campaign_logs_sent ON campaign_logs(sent_at);

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞—Ç—Ä–∏–±—É—Ü–∏—è (—Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ orders):
-- –ï—Å–ª–∏ order.status = 'paid' –ò –µ—Å—Ç—å campaign_log –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
-- ‚Üí –ø–æ–º–µ—á–∞–µ–º campaign_log –∫–∞–∫ converted
```

#### `product_reviews` - –û—Ç–∑—ã–≤—ã

```sql
CREATE TABLE product_reviews (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID REFERENCES products(id) ON DELETE CASCADE,
    order_id UUID REFERENCES orders(id),
    user_id UUID,
    email TEXT,
    
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    title TEXT,
    comment TEXT,
    
    verified_purchase BOOLEAN DEFAULT false,  -- –ò–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞?
    helpful_count INTEGER DEFAULT 0,          -- –õ–∞–π–∫–∏
    reported BOOLEAN DEFAULT false,
    
    status TEXT DEFAULT 'pending',            -- 'pending', 'approved', 'rejected'
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_reviews_product ON product_reviews(product_id);
CREATE INDEX idx_reviews_status ON product_reviews(status);
```

#### `purchase_stats` - –°—á—ë—Ç—á–∏–∫–∏ –ø–æ–∫—É–ø–æ–∫ (social proof)

```sql
CREATE TABLE purchase_stats (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID REFERENCES products(id) ON DELETE CASCADE,
    date DATE DEFAULT CURRENT_DATE,
    
    real_purchases INTEGER DEFAULT 0,      -- –†–µ–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ
    displayed_count INTEGER,               -- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º–æ–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å boosted)
    
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(product_id, date)
);

-- –õ–æ–≥–∏–∫–∞ boosting (–µ—Å–ª–∏ < 100 –ø–æ–∫—É–ø–æ–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 100-300):
displayed_count = 
  CASE 
    WHEN real_purchases < 100 
    THEN GREATEST(100, real_purchases) + (hours_today * 2)  -- –†–æ—Å—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
    ELSE real_purchases
  END

-- –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ orders.status = 'paid'
```

### 4. UNIT ECONOMICS TABLES

#### `transaction_fees` - –ö–æ–º–∏—Å—Å–∏–∏

```sql
CREATE TABLE transaction_fees (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
    payment_id UUID REFERENCES payments(id),
    
    fee_type TEXT NOT NULL,                -- 'payment_gateway', 'platform', 'currency_conversion'
    fee_amount NUMERIC(10,2) NOT NULL,
    fee_percentage NUMERIC(5,2),
    currency TEXT DEFAULT 'USD',
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ü—Ä–∏–º–µ—Ä: Cardlink –±–µ—Ä—ë—Ç 2.9% + $0.30
{
  "order_id": "order-uuid",
  "fee_type": "payment_gateway",
  "fee_amount": 2.48,                      -- (75 * 0.029) + 0.30
  "fee_percentage": 2.90
}
```

#### `refunds` - –í–æ–∑–≤—Ä–∞—Ç—ã

```sql
CREATE TABLE refunds (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID REFERENCES orders(id) ON DELETE CASCADE,
    payment_id UUID REFERENCES payments(id),
    
    refund_amount NUMERIC(10,2) NOT NULL,
    refund_reason TEXT,
    refund_type TEXT DEFAULT 'full',       -- 'full', 'partial'
    
    status TEXT DEFAULT 'pending',         -- 'pending', 'approved', 'rejected', 'completed'
    requested_by UUID,
    requested_at TIMESTAMPTZ DEFAULT NOW(),
    processed_at TIMESTAMPTZ
);
```

#### `ad_spend` - –†–µ–∫–ª–∞–º–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã

```sql
CREATE TABLE ad_spend (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    date DATE NOT NULL,
    
    utm_source TEXT,                       -- 'facebook', 'google'
    utm_campaign TEXT,
    utm_content TEXT,                      -- Ad creative
    
    spend NUMERIC(10,2) NOT NULL,          -- –°—É–º–º–∞ –ø–æ—Ç—Ä–∞—á–µ–Ω–∞
    currency TEXT DEFAULT 'USD',
    
    clicks INTEGER,
    impressions INTEGER,
    
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(date, utm_source, utm_campaign, utm_content)
);

-- –ò–º–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ CSV –∏–ª–∏ API:
INSERT INTO ad_spend (date, utm_source, utm_campaign, spend)
VALUES ('2025-01-15', 'facebook', 'black_friday', 500.00);

-- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ ROI, MER, CAC
```

### 5. PARTNER/AFFILIATE TABLES

#### `partner_accounts` - –ü–∞—Ä—Ç–Ω—ë—Ä—ã

```sql
CREATE TABLE partner_accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    partner_name TEXT NOT NULL,
    partner_email TEXT NOT NULL,
    
    -- API credentials
    api_key TEXT UNIQUE NOT NULL,          -- pk_live_...
    api_secret TEXT NOT NULL,              -- sk_live_...
    
    tenant_id UUID REFERENCES tenants(id),
    
    commission_rate NUMERIC(5,2) DEFAULT 10.00,  -- 10%
    
    status TEXT DEFAULT 'active',          -- 'active', 'suspended', 'pending'
    settings JSONB DEFAULT '{}'::jsonb,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è API keys:
api_key = 'pk_live_' || gen_random_uuid()::text
api_secret = 'sk_live_' || gen_random_uuid()::text
```

#### `affiliate_links` - Affiliate —Å—Å—ã–ª–∫–∏

```sql
CREATE TABLE affiliate_links (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    partner_id UUID REFERENCES partner_accounts(id) ON DELETE CASCADE,
    
    link_code TEXT UNIQUE NOT NULL,        -- 'SPECIAL10', 'PARTNER123'
    product_id UUID REFERENCES products(id),
    
    -- Stats
    clicks INTEGER DEFAULT 0,
    conversions INTEGER DEFAULT 0,
    revenue NUMERIC(10,2) DEFAULT 0,
    commission NUMERIC(10,2) DEFAULT 0,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- URL format: https://site.com/product/ID?ref=SPECIAL10

-- Tracking:
-- 1. Click ‚Üí increment clicks
-- 2. Order ‚Üí increment conversions, revenue, commission
```

#### `partner_payouts` - –í—ã–ø–ª–∞—Ç—ã –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º

```sql
CREATE TABLE partner_payouts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    partner_id UUID REFERENCES partner_accounts(id) ON DELETE CASCADE,
    
    amount NUMERIC(10,2) NOT NULL,
    currency TEXT DEFAULT 'USD',
    
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    
    status TEXT DEFAULT 'pending',         -- 'pending', 'approved', 'paid', 'cancelled'
    payment_method TEXT,                   -- 'bank_transfer', 'paypal', 'crypto'
    payment_details JSONB,
    
    approved_by UUID,
    approved_at TIMESTAMPTZ,
    paid_at TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ job:
-- –ü–æ–¥—Å—á—ë—Ç –≤—Å–µ—Ö –∫–æ–Ω–≤–µ—Ä—Å–∏–π –∑–∞ –º–µ—Å—è—Ü ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ payout request
```

### 6. MULTI-TENANT TABLES

#### `tenants` - –ú—É–ª—å—Ç–∏-–¥–æ–º–µ–Ω—ã

```sql
CREATE TABLE tenants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,                    -- "Main Store"
    primary_domain TEXT UNIQUE NOT NULL,   -- "lonieve.com"
    
    theme_overrides JSONB,                 -- –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã
    settings JSONB DEFAULT '{}'::jsonb,
    
    status TEXT DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- theme_overrides example:
{
  "colors": {
    "primary": "#D4AF37",
    "background": "#0A0A0A"
  },
  "logo": "https://cdn.../logo.png",
  "texts": {
    "hero_title": "Custom Title"
  }
}
```

#### `domains` - –î–æ–º–µ–Ω—ã

```sql
CREATE TABLE domains (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    domain TEXT UNIQUE NOT NULL,           -- "shop.example.com"
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    
    is_primary BOOLEAN DEFAULT false,
    ssl_enabled BOOLEAN DEFAULT true,
    status TEXT DEFAULT 'active',
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ü—Ä–∏–º–µ—Ä: –æ–¥–∏–Ω tenant ‚Üí –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–º–µ–Ω–æ–≤
-- tenant1 ‚Üí lonieve.com (primary), shop.lonieve.com, lonieve.es
```

### 7. A/B TESTING TABLES

#### `experiments` - –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã

```sql
CREATE TABLE experiments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    key TEXT UNIQUE NOT NULL,              -- 'home_hero_v2', 'discount_25_vs_30'
    name TEXT NOT NULL,
    description TEXT,
    
    variants JSONB NOT NULL,               -- ["control", "variant_a", "variant_b"]
    traffic_allocation JSONB,              -- {"control": 50, "variant_a": 50}
    
    status TEXT DEFAULT 'draft',           -- 'draft', 'running', 'paused', 'completed'
    
    start_date TIMESTAMPTZ,
    end_date TIMESTAMPTZ,
    
    goal_metric TEXT,                      -- 'conversion_rate', 'revenue', 'aov'
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ü—Ä–∏–º–µ—Ä:
{
  "key": "discount_test",
  "variants": ["25_percent", "30_percent"],
  "traffic_allocation": {
    "25_percent": 50,
    "30_percent": 50
  },
  "goal_metric": "revenue"
}
```

#### `experiment_assignments` - –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è

```sql
CREATE TABLE experiment_assignments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    experiment_id UUID REFERENCES experiments(id) ON DELETE CASCADE,
    
    session_id TEXT NOT NULL,              -- –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ session
    variant TEXT NOT NULL,                 -- "control" –∏–ª–∏ "variant_a"
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(experiment_id, session_id)
);

-- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∏–∑–∏—Ç–µ:
-- 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ experiments
-- 2. –ù–∞–∑–Ω–∞—á–∞–µ–º variant (hash session_id % 100)
-- 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ experiment_assignments
-- 4. –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –≤–∏–∑–∏—Ç—ã ‚Üí —Ç–æ—Ç –∂–µ variant
```

### 8. SYSTEM TABLES

#### `system_notifications` - –ê–ª–µ—Ä—Ç—ã

```sql
CREATE TABLE system_notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    type TEXT NOT NULL,                    -- 'low_stock', 'failed_email', 'pending_payment'
    severity TEXT DEFAULT 'info',          -- 'info', 'warning', 'critical'
    
    title TEXT NOT NULL,
    message TEXT NOT NULL,
    data JSONB,
    
    is_resolved BOOLEAN DEFAULT false,
    resolved_by UUID,
    resolved_at TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_notifications_resolved ON system_notifications(is_resolved);
```

#### `webhook_logs` - –õ–æ–≥–∏ webhooks

```sql
CREATE TABLE webhook_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    source TEXT NOT NULL,                  -- 'cardlink', 'stripe'
    event_type TEXT NOT NULL,              -- 'payment.success'
    
    order_id UUID REFERENCES orders(id),
    
    request_headers JSONB,
    request_body JSONB,
    response_status INTEGER,
    response_body JSONB,
    
    processed BOOLEAN DEFAULT false,
    error TEXT,
    
    processing_time_ms INTEGER,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_webhook_logs_order ON webhook_logs(order_id);
CREATE INDEX idx_webhook_logs_processed ON webhook_logs(processed);
```

#### `system_health_metrics` - –ú–µ—Ç—Ä–∏–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è

```sql
CREATE TABLE system_health_metrics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    metric_type TEXT NOT NULL,             -- 'uptime', 'latency', 'webhook_latency'
    metric_value NUMERIC NOT NULL,
    details JSONB,
    recorded_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_health_metrics_type ON system_health_metrics(metric_type);
CREATE INDEX idx_health_metrics_recorded ON system_health_metrics(recorded_at);

-- –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º webhook:
INSERT INTO system_health_metrics (metric_type, metric_value)
VALUES ('webhook_latency', 125);  -- ms
```

#### `scheduled_jobs` - –ó–∞–¥–∞—á–∏

```sql
CREATE TABLE scheduled_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    job_name TEXT UNIQUE NOT NULL,
    job_type TEXT NOT NULL,                -- 'sql_function', 'api_call', 'email_campaign'
    schedule TEXT NOT NULL,                -- Cron: '0 1 * * *'
    job_config JSONB NOT NULL,
    
    enabled BOOLEAN DEFAULT true,
    
    last_run_at TIMESTAMPTZ,
    last_run_status TEXT,
    last_run_duration_ms INTEGER,
    next_run_at TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ü—Ä–∏–º–µ—Ä—ã jobs:
{
  "job_name": "refresh_daily_metrics",
  "schedule": "0 1 * * *",              -- –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 1:00 AM
  "job_config": {
    "function": "REFRESH MATERIALIZED VIEW daily_metrics"
  }
}

{
  "job_name": "send_daily_insights",
  "schedule": "0 9 * * *",              -- –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 9:00 AM
  "job_config": {
    "endpoint": "/api/insights/generate",
    "method": "GET"
  }
}
```

#### `job_logs` - –õ–æ–≥–∏ jobs

```sql
CREATE TABLE job_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    job_id UUID REFERENCES scheduled_jobs(id) ON DELETE CASCADE,
    job_name TEXT NOT NULL,
    
    started_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ,
    
    status TEXT DEFAULT 'running',         -- 'running', 'success', 'failed', 'cancelled'
    duration_ms INTEGER,
    result JSONB,
    error_message TEXT,
    logs TEXT
);

CREATE INDEX idx_job_logs_job_id ON job_logs(job_id);
CREATE INDEX idx_job_logs_started ON job_logs(started_at);
```

### 9. AI COPILOT TABLES

#### `ai_queries` - AI –∑–∞–ø—Ä–æ—Å—ã

```sql
CREATE TABLE ai_queries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID,
    
    query_text TEXT NOT NULL,              -- "Show me revenue for last 7 days"
    query_intent TEXT,                     -- 'revenue', 'profit', 'customers'
    
    sql_executed TEXT,                     -- SQL –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω–∏–ª–∏
    response TEXT,                         -- JSON response
    response_time_ms INTEGER,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_ai_queries_user ON ai_queries(user_id);
CREATE INDEX idx_ai_queries_created ON ai_queries(created_at);

-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
SELECT query_intent, COUNT(*), AVG(response_time_ms)
FROM ai_queries
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY query_intent
ORDER BY COUNT(*) DESC;
```

#### `telegram_bot_users` - Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

```sql
CREATE TABLE telegram_bot_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    telegram_user_id BIGINT UNIQUE NOT NULL,
    telegram_username TEXT,
    
    user_id UUID,                          -- Link to admin user
    role TEXT DEFAULT 'viewer',            -- 'admin', 'manager', 'viewer'
    
    is_active BOOLEAN DEFAULT true,
    last_command TEXT,
    last_active_at TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### `telegram_commands` - Telegram –∫–æ–º–∞–Ω–¥—ã

```sql
CREATE TABLE telegram_commands (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    command TEXT UNIQUE NOT NULL,          -- '/daily', '/revenue'
    description TEXT,
    
    sql_function TEXT,                     -- SQL function to call
    response_format TEXT DEFAULT 'text',   -- 'text', 'chart', 'table'
    requires_role TEXT DEFAULT 'viewer',
    
    enabled BOOLEAN DEFAULT true
);

-- Default commands —É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –º–∏–≥—Ä–∞—Ü–∏–∏
```

---

## üîß SQL –§–£–ù–ö–¶–ò–ò (–í–°–ï 20+)

### 1. Analytics Functions

#### `get_funnel_stats()` - –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

```sql
CREATE OR REPLACE FUNCTION get_funnel_stats(
    start_date TIMESTAMPTZ DEFAULT NOW() - INTERVAL '7 days',
    end_date TIMESTAMPTZ DEFAULT NOW()
)
RETURNS TABLE (
    step_name TEXT,
    unique_sessions BIGINT,
    conversion_from_previous NUMERIC,
    overall_conversion NUMERIC
) AS $$
DECLARE
    total_sessions BIGINT;
BEGIN
    -- Get total unique sessions
    SELECT COUNT(DISTINCT session_id) INTO total_sessions
    FROM events
    WHERE created_at BETWEEN start_date AND end_date;
    
    RETURN QUERY
    WITH funnel_steps AS (
        SELECT
            'Page View' AS step,
            1 AS order_num,
            COUNT(DISTINCT session_id) AS sessions
        FROM events
        WHERE event_type = 'page_view'
        AND created_at BETWEEN start_date AND end_date
        
        UNION ALL
        
        SELECT
            'Product View' AS step,
            2 AS order_num,
            COUNT(DISTINCT session_id)
        FROM events
        WHERE event_type = 'view_product'
        AND created_at BETWEEN start_date AND end_date
        
        UNION ALL
        
        SELECT
            'Add to Cart' AS step,
            3 AS order_num,
            COUNT(DISTINCT session_id)
        FROM events
        WHERE event_type = 'add_to_cart'
        AND created_at BETWEEN start_date AND end_date
        
        UNION ALL
        
        SELECT
            'Checkout Start' AS step,
            4 AS order_num,
            COUNT(DISTINCT session_id)
        FROM events
        WHERE event_type = 'checkout_start'
        AND created_at BETWEEN start_date AND end_date
        
        UNION ALL
        
        SELECT
            'Payment' AS step,
            5 AS order_num,
            COUNT(DISTINCT o.session_id)
        FROM orders o
        WHERE o.status = 'paid'
        AND o.created_at BETWEEN start_date AND end_date
    )
    SELECT
        f.step,
        f.sessions,
        ROUND(
            (f.sessions::NUMERIC / 
             NULLIF(LAG(f.sessions) OVER (ORDER BY f.order_num), 0) * 100),
            2
        ) AS conversion_from_prev,
        ROUND(
            (f.sessions::NUMERIC / NULLIF(total_sessions, 0) * 100),
            2
        ) AS overall_conv
    FROM funnel_steps f
    ORDER BY f.order_num;
END;
$$ LANGUAGE plpgsql;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
SELECT * FROM get_funnel_stats(
    NOW() - INTERVAL '7 days',
    NOW()
);

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
step_name       | unique_sessions | conversion_from_previous | overall_conversion
Page View       | 10000          | NULL                     | 100.00
Product View    | 5000           | 50.00                    | 50.00
Add to Cart     | 1000           | 20.00                    | 10.00
Checkout Start  | 500            | 50.00                    | 5.00
Payment         | 200            | 40.00                    | 2.00
```

#### `get_channel_stats_financial()` - –ö–∞–Ω–∞–ª—ã —Å ROI

```sql
CREATE OR REPLACE FUNCTION get_channel_stats_financial(
    start_date TIMESTAMPTZ DEFAULT NOW() - INTERVAL '7 days',
    end_date TIMESTAMPTZ DEFAULT NOW(),
    filter_tenant_id UUID DEFAULT NULL
)
RETURNS TABLE (
    utm_source TEXT,
    utm_campaign TEXT,
    sessions BIGINT,
    orders BIGINT,
    revenue NUMERIC,
    cost NUMERIC,
    profit NUMERIC,
    ad_spend NUMERIC,
    roi_percentage NUMERIC,
    mer NUMERIC,
    conversion_rate NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH channel_orders AS (
        SELECT
            COALESCE(o.utm_source, 'Direct') AS source,
            COALESCE(o.utm_campaign, 'N/A') AS campaign,
            COUNT(DISTINCT o.session_id) AS sess,
            COUNT(o.id) FILTER (WHERE o.status = 'paid') AS ord,
            COALESCE(SUM(o.total_amount) FILTER (WHERE o.status = 'paid'), 0) AS rev,
            COALESCE(SUM(o.total_cost) FILTER (WHERE o.status = 'paid'), 0) AS cst,
            COALESCE(SUM(o.total_profit) FILTER (WHERE o.status = 'paid'), 0) AS prof
        FROM orders o
        WHERE o.created_at BETWEEN start_date AND end_date
        AND (filter_tenant_id IS NULL OR o.tenant_id = filter_tenant_id)
        GROUP BY COALESCE(o.utm_source, 'Direct'), COALESCE(o.utm_campaign, 'N/A')
    ),
    channel_spend AS (
        SELECT
            COALESCE(a.utm_source, 'Direct') AS source,
            COALESCE(a.utm_campaign, 'N/A') AS campaign,
            COALESCE(SUM(a.spend), 0) AS spend
        FROM ad_spend a
        WHERE a.date BETWEEN start_date::DATE AND end_date::DATE
        GROUP BY COALESCE(a.utm_source, 'Direct'), COALESCE(a.utm_campaign, 'N/A')
    )
    SELECT
        co.source,
        co.campaign,
        co.sess,
        co.ord,
        co.rev,
        co.cst,
        co.prof,
        COALESCE(cs.spend, 0) AS spend,
        -- ROI = (Profit - Spend) / Spend * 100
        CASE 
            WHEN COALESCE(cs.spend, 0) > 0 
            THEN ROUND(((co.prof - COALESCE(cs.spend, 0)) / cs.spend * 100), 2)
            ELSE 0
        END AS roi,
        -- MER = Revenue / Spend
        CASE 
            WHEN COALESCE(cs.spend, 0) > 0 
            THEN ROUND((co.rev / cs.spend), 2)
            ELSE 0
        END AS mer_val,
        -- Conversion Rate
        ROUND((co.ord::NUMERIC / NULLIF(co.sess, 0) * 100), 2) AS conv_rate
    FROM channel_orders co
    LEFT JOIN channel_spend cs 
        ON co.source = cs.source 
        AND co.campaign = cs.campaign
    WHERE co.ord > 0
    ORDER BY co.prof DESC;
END;
$$ LANGUAGE plpgsql;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
SELECT * FROM get_channel_stats_financial(
    NOW() - INTERVAL '30 days',
    NOW(),
    NULL
);

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
utm_source | utm_campaign | sessions | orders | revenue  | profit  | ad_spend | roi_percentage | mer
Facebook   | black_friday | 5000     | 200    | 15000.00 | 3750.00 | 1000.00  | 275.00         | 15.00
Google     | generic      | 3000     | 100    | 7500.00  | 1875.00 | 800.00   | 134.38         | 9.38
Direct     | N/A          | 2000     | 50     | 3750.00  | 937.50  | 0.00     | 0.00           | 0.00
```

#### `get_ltv_by_cohort()` - LTV –ø–æ –∫–æ–≥–æ—Ä—Ç–∞–º

```sql
CREATE OR REPLACE FUNCTION get_ltv_by_cohort(
    cohort_period_days INTEGER DEFAULT 30
)
RETURNS TABLE (
    cohort_month TEXT,
    customers_count BIGINT,
    total_ltv NUMERIC,
    avg_ltv NUMERIC,
    repeat_customers BIGINT,
    repeat_rate NUMERIC,
    avg_orders_per_customer NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    WITH first_purchases AS (
        SELECT
            email,
            user_id,
            DATE_TRUNC('month', MIN(created_at)) AS cohort_month
        FROM orders
        WHERE status = 'paid'
        GROUP BY email, user_id
    ),
    customer_stats AS (
        SELECT
            fp.cohort_month,
            fp.email,
            COUNT(o.id) AS order_count,
            SUM(o.total_amount) AS ltv
        FROM first_purchases fp
        JOIN orders o ON o.email = fp.email AND o.status = 'paid'
        GROUP BY fp.cohort_month, fp.email
    )
    SELECT
        TO_CHAR(cs.cohort_month, 'YYYY-MM') AS month,
        COUNT(DISTINCT cs.email) AS customers,
        ROUND(SUM(cs.ltv), 2) AS total,
        ROUND(AVG(cs.ltv), 2) AS avg,
        COUNT(DISTINCT cs.email) FILTER (WHERE cs.order_count > 1) AS repeat,
        ROUND((COUNT(DISTINCT cs.email) FILTER (WHERE cs.order_count > 1)::NUMERIC / 
               NULLIF(COUNT(DISTINCT cs.email), 0) * 100), 2) AS repeat_pct,
        ROUND(AVG(cs.order_count), 2) AS avg_orders
    FROM customer_stats cs
    GROUP BY cs.cohort_month
    ORDER BY cs.cohort_month DESC;
END;
$$ LANGUAGE plpgsql;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
SELECT * FROM get_ltv_by_cohort(30);

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
cohort_month | customers | total_ltv | avg_ltv | repeat_customers | repeat_rate | avg_orders
2025-01      | 150       | 15000.00  | 100.00  | 38               | 25.33       | 1.35
2024-12      | 200       | 22000.00  | 110.00  | 60               | 30.00       | 1.45
2024-11      | 180       | 19800.00  | 110.00  | 54               | 30.00       | 1.40
```

#### `detect_anomalies()` - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π

```sql
CREATE OR REPLACE FUNCTION detect_anomalies()
RETURNS TABLE (
    insight_type TEXT,
    severity TEXT,
    title TEXT,
    description TEXT,
    metric_value NUMERIC,
    baseline_value NUMERIC,
    change_percentage NUMERIC,
    recommendation TEXT
) AS $$
DECLARE
    today_cr NUMERIC;
    yesterday_cr NUMERIC;
    week_avg_cr NUMERIC;
    today_revenue NUMERIC;
    yesterday_revenue NUMERIC;
BEGIN
    -- Check 1: Conversion Rate Drop
    SELECT conversion_rate INTO today_cr
    FROM daily_metrics
    WHERE date = CURRENT_DATE
    ORDER BY revenue DESC NULLS LAST
    LIMIT 1;
    
    SELECT AVG(conversion_rate) INTO week_avg_cr
    FROM daily_metrics
    WHERE date >= CURRENT_DATE - INTERVAL '7 days'
        AND date < CURRENT_DATE;
    
    IF today_cr IS NOT NULL AND week_avg_cr IS NOT NULL AND today_cr < week_avg_cr * 0.85 THEN
        RETURN QUERY SELECT
            'conversion_drop'::TEXT,
            'critical'::TEXT,
            'Conversion Rate Drop Detected'::TEXT,
            'Today''s CR is 15% lower than weekly average'::TEXT,
            today_cr,
            week_avg_cr,
            ROUND(((today_cr - week_avg_cr) / week_avg_cr * 100), 2),
            'Check traffic quality, payment gateway status, and site performance'::TEXT;
    END IF;
    
    -- Check 2: Revenue Spike/Drop
    SELECT revenue INTO today_revenue
    FROM daily_metrics
    WHERE date = CURRENT_DATE
    ORDER BY revenue DESC NULLS LAST
    LIMIT 1;
    
    SELECT revenue INTO yesterday_revenue
    FROM daily_metrics
    WHERE date = CURRENT_DATE - INTERVAL '1 day'
    ORDER BY revenue DESC NULLS LAST
    LIMIT 1;
    
    IF today_revenue IS NOT NULL AND yesterday_revenue IS NOT NULL THEN
        IF today_revenue > yesterday_revenue * 1.5 THEN
            RETURN QUERY SELECT
                'revenue_spike'::TEXT,
                'info'::TEXT,
                'Revenue Spike'::TEXT,
                'Revenue increased 50%+ vs yesterday'::TEXT,
                today_revenue,
                yesterday_revenue,
                ROUND(((today_revenue - yesterday_revenue) / yesterday_revenue * 100), 2),
                'Great! Consider scaling successful channels'::TEXT;
        ELSIF today_revenue < yesterday_revenue * 0.7 THEN
            RETURN QUERY SELECT
                'revenue_drop'::TEXT,
                'warning'::TEXT,
                'Revenue Drop'::TEXT,
                'Revenue decreased 30%+ vs yesterday'::TEXT,
                today_revenue,
                yesterday_revenue,
                ROUND(((today_revenue - yesterday_revenue) / yesterday_revenue * 100), 2),
                'Check marketing campaigns and traffic sources'::TEXT;
        END IF;
    END IF;
    
    -- Check 3: Best Channel
    RETURN QUERY
    WITH channel_perf AS (
        SELECT
            utm_source,
            utm_campaign,
            revenue,
            profit,
            CASE WHEN revenue > 0 THEN ROUND((profit / revenue * 100), 2) ELSE 0 END AS margin
        FROM daily_metrics
        WHERE date = CURRENT_DATE
            AND revenue > 0
        ORDER BY profit DESC
    )
    SELECT
        'best_channel'::TEXT,
        'info'::TEXT,
        'Best Performing Channel'::TEXT,
        'Highest profit channel today: ' || utm_source || ' / ' || utm_campaign,
        profit,
        revenue,
        margin,
        'Consider increasing budget for this channel'::TEXT
    FROM channel_perf
    LIMIT 1;
END;
$$ LANGUAGE plpgsql;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
SELECT * FROM detect_anomalies();
```

#### `get_unit_economics()` - Unit Economics

```sql
CREATE OR REPLACE FUNCTION get_unit_economics(
    start_date TIMESTAMPTZ DEFAULT NOW() - INTERVAL '30 days',
    end_date TIMESTAMPTZ DEFAULT NOW()
)
RETURNS TABLE (
    metric_name TEXT,
    metric_value NUMERIC,
    period_comparison NUMERIC
) AS $$
DECLARE
    current_orders BIGINT;
    current_revenue NUMERIC;
    current_cost NUMERIC;
    current_profit NUMERIC;
    current_fees NUMERIC;
    current_refunds NUMERIC;
    current_ad_spend NUMERIC;
    true_profit_total NUMERIC;
    cac NUMERIC;
    ltv NUMERIC;
    aov NUMERIC;
BEGIN
    -- Current period stats
    SELECT 
        COUNT(*) FILTER (WHERE status = 'paid'),
        SUM(total_amount) FILTER (WHERE status = 'paid'),
        SUM(total_cost) FILTER (WHERE status = 'paid'),
        SUM(total_profit) FILTER (WHERE status = 'paid'),
        SUM(transaction_fees) FILTER (WHERE status = 'paid'),
        SUM(refund_amount) FILTER (WHERE status = 'paid')
    INTO 
        current_orders,
        current_revenue,
        current_cost,
        current_profit,
        current_fees,
        current_refunds
    FROM orders
    WHERE created_at BETWEEN start_date AND end_date;
    
    -- Get ad spend
    SELECT COALESCE(SUM(spend), 0) INTO current_ad_spend
    FROM ad_spend
    WHERE date BETWEEN start_date::DATE AND end_date::DATE;
    
    -- Calculate metrics
    true_profit_total := COALESCE(current_profit, 0) - COALESCE(current_fees, 0) - COALESCE(current_refunds, 0);
    aov := CASE WHEN current_orders > 0 THEN current_revenue / current_orders ELSE 0 END;
    cac := CASE WHEN current_orders > 0 THEN current_ad_spend / current_orders ELSE 0 END;
    ltv := aov; -- For gift cards, LTV ‚âà AOV
    
    -- Return metrics
    RETURN QUERY
    SELECT 'Total Orders'::TEXT, current_orders::NUMERIC, 0::NUMERIC
    UNION ALL SELECT 'Revenue'::TEXT, COALESCE(current_revenue, 0), 0::NUMERIC
    UNION ALL SELECT 'Cost'::TEXT, COALESCE(current_cost, 0), 0::NUMERIC
    UNION ALL SELECT 'Gross Profit'::TEXT, COALESCE(current_profit, 0), 0::NUMERIC
    UNION ALL SELECT 'Transaction Fees'::TEXT, COALESCE(current_fees, 0), 0::NUMERIC
    UNION ALL SELECT 'Refunds'::TEXT, COALESCE(current_refunds, 0), 0::NUMERIC
    UNION ALL SELECT 'Ad Spend'::TEXT, current_ad_spend, 0::NUMERIC
    UNION ALL SELECT 'True Profit'::TEXT, true_profit_total, 0::NUMERIC
    UNION ALL SELECT 'AOV'::TEXT, aov, 0::NUMERIC
    UNION ALL SELECT 'LTV'::TEXT, ltv, 0::NUMERIC
    UNION ALL SELECT 'CAC'::TEXT, cac, 0::NUMERIC
    UNION ALL SELECT 'LTV/CAC Ratio'::TEXT, CASE WHEN cac > 0 THEN ROUND(ltv / cac, 2) ELSE 0 END, 0::NUMERIC;
END;
$$ LANGUAGE plpgsql;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
SELECT * FROM get_unit_economics(
    NOW() - INTERVAL '30 days',
    NOW()
);

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
metric_name           | metric_value
Total Orders          | 150
Revenue               | 15000.00
Cost                  | 11250.00
Gross Profit          | 3750.00
Transaction Fees      | 450.00
Refunds               | 150.00
Ad Spend              | 1500.00
True Profit           | 1650.00
AOV                   | 100.00
LTV                   | 100.00
CAC                   | 10.00
LTV/CAC Ratio         | 10.00
```

#### `get_rfm_segments()` - RFM —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è

```sql
CREATE OR REPLACE FUNCTION get_rfm_segments()
RETURNS TABLE (
    customer_email TEXT,
    recency_days INTEGER,
    frequency INTEGER,
    monetary NUMERIC,
    rfm_score TEXT,
    segment TEXT,
    segment_description TEXT
) AS $$
BEGIN
    RETURN QUERY
    WITH customer_metrics AS (
        SELECT
            o.email,
            EXTRACT(DAY FROM (NOW() - MAX(o.created_at)))::INTEGER AS recency,
            COUNT(*)::INTEGER AS frequency,
            SUM(o.total_amount)::NUMERIC AS monetary
        FROM orders o
        WHERE o.status = 'paid'
        GROUP BY o.email
    ),
    rfm_quartiles AS (
        SELECT
            email,
            recency,
            frequency,
            monetary,
            NTILE(5) OVER (ORDER BY recency DESC) AS r_score,
            NTILE(5) OVER (ORDER BY frequency) AS f_score,
            NTILE(5) OVER (ORDER BY monetary) AS m_score
        FROM customer_metrics
    ),
    rfm_segments AS (
        SELECT
            email,
            recency,
            frequency,
            monetary,
            CONCAT(r_score::TEXT, f_score::TEXT, m_score::TEXT) AS rfm,
            CASE
                WHEN r_score >= 4 AND f_score >= 4 AND m_score >= 4 THEN 'VIP Champions'
                WHEN f_score >= 4 THEN 'Loyal Customers'
                WHEN m_score >= 4 THEN 'Big Spenders'
                WHEN r_score <= 2 AND f_score >= 3 THEN 'At Risk'
                WHEN r_score >= 4 AND f_score <= 2 THEN 'Promising'
                WHEN r_score = 3 AND f_score = 3 THEN 'Need Attention'
                WHEN r_score <= 2 AND f_score <= 2 THEN 'Lost'
                ELSE 'Regular'
            END AS segment,
            CASE
                WHEN r_score >= 4 AND f_score >= 4 AND m_score >= 4 THEN 'Your best customers - nurture and retain'
                WHEN f_score >= 4 THEN 'Regular buyers - upsell and cross-sell'
                WHEN m_score >= 4 THEN 'High value - encourage repeat purchases'
                WHEN r_score <= 2 AND f_score >= 3 THEN 'Previously engaged - winback campaign'
                WHEN r_score >= 4 AND f_score <= 2 THEN 'New customers - convert to loyal'
                WHEN r_score = 3 AND f_score = 3 THEN 'Middle ground - targeted offers'
                WHEN r_score <= 2 AND f_score <= 2 THEN 'Inactive - aggressive winback or let go'
                ELSE 'Standard customers - maintain engagement'
            END AS description
        FROM rfm_quartiles
    )
    SELECT * FROM rfm_segments
    ORDER BY 
        CASE segment
            WHEN 'VIP Champions' THEN 1
            WHEN 'Loyal Customers' THEN 2
            WHEN 'Big Spenders' THEN 3
            WHEN 'Promising' THEN 4
            WHEN 'Need Attention' THEN 5
            WHEN 'At Risk' THEN 6
            WHEN 'Lost' THEN 7
            ELSE 8
        END,
        monetary DESC;
END;
$$ LANGUAGE plpgsql;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
SELECT * FROM get_rfm_segments();

-- VIP Champions —Ç–æ–ª—å–∫–æ:
SELECT * FROM get_rfm_segments()
WHERE segment = 'VIP Champions'
ORDER BY monetary DESC
LIMIT 10;
```

#### `get_abandoned_checkouts()` - –ë—Ä–æ—à–µ–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã

```sql
CREATE OR REPLACE FUNCTION get_abandoned_checkouts(
    minutes_ago INTEGER DEFAULT 360
)
RETURNS TABLE (
    session_id TEXT,
    user_id UUID,
    email TEXT,
    product_data JSONB,
    checkout_started_at TIMESTAMPTZ,
    minutes_since INTEGER,
    utm_source TEXT,
    utm_campaign TEXT
) AS $$
BEGIN
    RETURN QUERY
    WITH checkout_sessions AS (
        SELECT DISTINCT ON (e.session_id)
            e.session_id,
            e.user_id,
            e.data->>'email' AS email,
            e.data AS product_data,
            e.created_at AS checkout_time,
            e.utm_source,
            e.utm_campaign
        FROM events e
        WHERE e.event_type = 'checkout_start'
            AND e.created_at >= NOW() - (minutes_ago || ' minutes')::INTERVAL
            AND e.created_at <= NOW() - INTERVAL '30 minutes'
        ORDER BY e.session_id, e.created_at DESC
    )
    SELECT
        cs.session_id,
        cs.user_id,
        cs.email,
        cs.product_data,
        cs.checkout_time,
        EXTRACT(EPOCH FROM (NOW() - cs.checkout_time))::INTEGER / 60 AS mins,
        cs.utm_source,
        cs.utm_campaign
    FROM checkout_sessions cs
    WHERE NOT EXISTS (
        SELECT 1
        FROM orders o
        WHERE o.session_id = cs.session_id
            AND o.status = 'paid'
    )
    ORDER BY cs.checkout_time DESC;
END;
$$ LANGUAGE plpgsql;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
SELECT * FROM get_abandoned_checkouts(360);

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
session_id   | email              | product_data                    | minutes_since
sess_abc123  | john@example.com   | {"product_id": "uuid", ...}     | 45
sess_xyz789  | jane@example.com   | {"product_id": "uuid2", ...}    | 120
```

#### `get_winback_candidates()` - Winback –∫–∞–Ω–¥–∏–¥–∞—Ç—ã

```sql
CREATE OR REPLACE FUNCTION get_winback_candidates(
    days_since_last INTEGER DEFAULT 30,
    min_previous_orders INTEGER DEFAULT 2
)
RETURNS TABLE (
    email TEXT,
    user_id UUID,
    last_order_date TIMESTAMPTZ,
    days_since_last_order INTEGER,
    total_orders BIGINT,
    total_spent NUMERIC,
    avg_order_value NUMERIC,
    favorite_brand TEXT,
    last_utm_source TEXT,
    last_utm_campaign TEXT
) AS $$
BEGIN
    RETURN QUERY
    WITH customer_stats AS (
        SELECT
            o.email,
            o.user_id,
            MAX(o.created_at) AS last_order,
            COUNT(*) AS order_count,
            SUM(o.total_amount) AS total_revenue,
            AVG(o.total_amount) AS avg_aov
        FROM orders o
        WHERE o.status = 'paid'
        GROUP BY o.email, o.user_id
        HAVING COUNT(*) >= min_previous_orders
            AND MAX(o.created_at) < NOW() - (days_since_last || ' days')::INTERVAL
    ),
    customer_preferences AS (
        SELECT
            o.email,
            p.brand,
            COUNT(*) AS brand_count,
            ROW_NUMBER() OVER (PARTITION BY o.email ORDER BY COUNT(*) DESC) AS rn
        FROM orders o
        JOIN order_items oi ON oi.order_id = o.id
        JOIN products p ON p.id = oi.product_id
        WHERE o.status = 'paid'
        GROUP BY o.email, p.brand
    ),
    last_utm AS (
        SELECT DISTINCT ON (o.email)
            o.email,
            o.utm_source,
            o.utm_campaign
        FROM orders o
        WHERE o.status = 'paid'
        ORDER BY o.email, o.created_at DESC
    )
    SELECT
        cs.email,
        cs.user_id,
        cs.last_order,
        EXTRACT(DAY FROM (NOW() - cs.last_order))::INTEGER AS days_since,
        cs.order_count,
        ROUND(cs.total_revenue, 2) AS total,
        ROUND(cs.avg_aov, 2) AS avg_aov,
        cp.brand AS fav_brand,
        lu.utm_source,
        lu.utm_campaign
    FROM customer_stats cs
    LEFT JOIN customer_preferences cp ON cp.email = cs.email AND cp.rn = 1
    LEFT JOIN last_utm lu ON lu.email = cs.email
    ORDER BY cs.total_revenue DESC;
END;
$$ LANGUAGE plpgsql;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
SELECT * FROM get_winback_candidates(30, 2);

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
email            | days_since_last | total_orders | total_spent | favorite_brand
john@example.com | 35              | 5            | 500.00      | Amazon
jane@example.com | 42              | 3            | 300.00      | PlayStation
```

#### `get_system_health()` - –ó–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã

```sql
CREATE OR REPLACE FUNCTION get_system_health()
RETURNS TABLE (
    metric_name TEXT,
    current_value NUMERIC,
    avg_24h NUMERIC,
    status TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        'webhook_avg_latency_ms'::TEXT,
        COALESCE((
            SELECT AVG(metric_value)
            FROM system_health_metrics
            WHERE metric_type = 'webhook_latency'
                AND recorded_at >= NOW() - INTERVAL '1 hour'
        ), 0)::NUMERIC,
        COALESCE((
            SELECT AVG(metric_value)
            FROM system_health_metrics
            WHERE metric_type = 'webhook_latency'
                AND recorded_at >= NOW() - INTERVAL '24 hours'
        ), 0)::NUMERIC,
        CASE
            WHEN COALESCE((SELECT AVG(metric_value) FROM system_health_metrics WHERE metric_type = 'webhook_latency' AND recorded_at >= NOW() - INTERVAL '1 hour'), 0) < 1000 THEN 'healthy'::TEXT
            WHEN COALESCE((SELECT AVG(metric_value) FROM system_health_metrics WHERE metric_type = 'webhook_latency' AND recorded_at >= NOW() - INTERVAL '1 hour'), 0) < 3000 THEN 'warning'::TEXT
            ELSE 'critical'::TEXT
        END
    UNION ALL
    SELECT
        'email_avg_send_time_ms'::TEXT,
        COALESCE((
            SELECT AVG(metric_value)
            FROM system_health_metrics
            WHERE metric_type = 'email_send_time'
                AND recorded_at >= NOW() - INTERVAL '1 hour'
        ), 0)::NUMERIC,
        COALESCE((
            SELECT AVG(metric_value)
            FROM system_health_metrics
            WHERE metric_type = 'email_send_time'
                AND recorded_at >= NOW() - INTERVAL '24 hours'
        ), 0)::NUMERIC,
        CASE
            WHEN COALESCE((SELECT AVG(metric_value) FROM system_health_metrics WHERE metric_type = 'email_send_time' AND recorded_at >= NOW() - INTERVAL '1 hour'), 0) < 2000 THEN 'healthy'::TEXT
            WHEN COALESCE((SELECT AVG(metric_value) FROM system_health_metrics WHERE metric_type = 'email_send_time' AND recorded_at >= NOW() - INTERVAL '1 hour'), 0) < 5000 THEN 'warning'::TEXT
            ELSE 'critical'::TEXT
        END;
END;
$$ LANGUAGE plpgsql;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
SELECT * FROM get_system_health();
```

#### AI Copilot Helper Functions

```sql
-- Get revenue for last N days
CREATE OR REPLACE FUNCTION ai_get_revenue_last_n_days(days INTEGER DEFAULT 7)
RETURNS NUMERIC AS $$
    SELECT COALESCE(SUM(total_amount), 0)
    FROM orders
    WHERE status = 'paid'
    AND created_at >= NOW() - (days || ' days')::INTERVAL;
$$ LANGUAGE SQL;

-- Get profit for last N days
CREATE OR REPLACE FUNCTION ai_get_profit_last_n_days(days INTEGER DEFAULT 7)
RETURNS NUMERIC AS $$
    SELECT COALESCE(SUM(total_profit), 0)
    FROM orders
    WHERE status = 'paid'
    AND created_at >= NOW() - (days || ' days')::INTERVAL;
$$ LANGUAGE SQL;

-- Get top products
CREATE OR REPLACE FUNCTION ai_get_top_products(limit_count INTEGER DEFAULT 10)
RETURNS TABLE (
    product_name TEXT,
    brand TEXT,
    orders_count BIGINT,
    revenue NUMERIC
) AS $$
    SELECT
        p.name,
        p.brand,
        COUNT(DISTINCT o.id) AS orders,
        SUM(oi.price) AS rev
    FROM order_items oi
    JOIN products p ON p.id = oi.product_id
    JOIN orders o ON o.id = oi.order_id AND o.status = 'paid'
    WHERE o.created_at >= NOW() - INTERVAL '30 days'
    GROUP BY p.id, p.name, p.brand
    ORDER BY rev DESC
    LIMIT limit_count;
$$ LANGUAGE SQL;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ AI Copilot:
SELECT ai_get_revenue_last_n_days(7);        -- $15,234.50
SELECT ai_get_profit_last_n_days(7);         -- $3,750.00
SELECT * FROM ai_get_top_products(10);
```

---

## üåê API ENDPOINTS (–í–°–ï 30+)

### E-COMMERCE API

#### `POST /api/orders/create` - –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑ –∏ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ Cardlink

**Request Body:**
```json
{
  "productId": "uuid",
  "nominal": 100,
  "price": 75.00,
  "email": "customer@example.com",
  "firstName": "John",
  "lastName": "Doe",
  "deliveryType": "myself",
  "recipientEmail": null,
  "giftMessage": null,
  "sessionId": "sess_abc123",
  "utm": {
    "utm_source": "facebook",
    "utm_medium": "cpc",
    "utm_campaign": "black_friday"
  }
}
```

**Response (200):**
```json
{
  "orderId": "order-uuid-123",
  "paymentUrl": "https://cardlink.com/pay/bill_abc123",
  "billId": "bill_abc123"
}
```

**–õ–æ–≥–∏–∫–∞:**
1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (Zod schema)
2. –°–æ–∑–¥–∞–Ω–∏–µ order –≤ –ë–î (status='pending')
3. –°–æ–∑–¥–∞–Ω–∏–µ payment –∑–∞–ø–∏—Å–∏
4. –í—ã–∑–æ–≤ Cardlink API `/bill/create`
5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ payment_url
6. –ó–∞–ø–∏—Å—å —Å–æ–±—ã—Ç–∏—è `payment_redirect`
7. –í–æ–∑–≤—Ä–∞—Ç payment_url –∫–ª–∏–µ–Ω—Ç—É

**–ö–æ–¥:**
```typescript
// src/app/api/orders/create/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { z } from 'zod';
import { cardlinkAPI } from '@/lib/cardlink/api';

const orderSchema = z.object({
  productId: z.string().uuid(),
  nominal: z.number().positive(),
  price: z.number().positive(),
  email: z.string().email(),
  firstName: z.string().optional(),
  lastName: z.string().optional(),
  deliveryType: z.enum(['myself', 'gift']),
  recipientEmail: z.string().email().optional(),
  giftMessage: z.string().optional(),
  sessionId: z.string(),
  utm: z.object({
    utm_source: z.string().optional(),
    utm_medium: z.string().optional(),
    utm_campaign: z.string().optional(),
    utm_content: z.string().optional(),
    utm_term: z.string().optional(),
  }).optional(),
});

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const validatedData = orderSchema.parse(body);
    
    const supabase = await createClient();
    
    // Get product info
    const { data: product } = await supabase
      .from('products')
      .select('*')
      .eq('id', validatedData.productId)
      .single();
    
    if (!product) {
      return NextResponse.json({ error: 'Product not found' }, { status: 404 });
    }
    
    // Create order
    const { data: order, error: orderError } = await supabase
      .from('orders')
      .insert({
        email: validatedData.email,
        first_name: validatedData.firstName,
        last_name: validatedData.lastName,
        total_amount: validatedData.price,
        currency: product.currency,
        status: 'pending',
        delivery_type: validatedData.deliveryType,
        recipient_email: validatedData.recipientEmail,
        gift_message: validatedData.giftMessage,
        session_id: validatedData.sessionId,
        utm_source: validatedData.utm?.utm_source,
        utm_medium: validatedData.utm?.utm_medium,
        utm_campaign: validatedData.utm?.utm_campaign,
        utm_content: validatedData.utm?.utm_content,
        utm_term: validatedData.utm?.utm_term,
        referrer: request.headers.get('referer'),
        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip'),
        user_agent: request.headers.get('user-agent'),
      })
      .select()
      .single();
    
    if (orderError) throw orderError;
    
    // Create order item
    await supabase.from('order_items').insert({
      order_id: order.id,
      product_id: product.id,
      product_name: product.name,
      product_brand: product.brand,
      nominal: validatedData.nominal,
      price: validatedData.price,
      quantity: 1,
      currency: product.currency,
    });
    
    // Create Cardlink bill
    const bill = await cardlinkAPI.createBill({
      amount: validatedData.price,
      currency: product.currency,
      orderId: order.id,
      customerEmail: validatedData.email,
      returnUrl: `${process.env.NEXT_PUBLIC_SITE_URL}/pending?orderId=${order.id}`,
    });
    
    // Save payment
    await supabase.from('payments').insert({
      order_id: order.id,
      bill_id: bill.bill_id,
      status: 'pending',
      amount: validatedData.price,
      currency: product.currency,
      payment_url: bill.payment_url,
    });
    
    // Update order with bill info
    await supabase
      .from('orders')
      .update({
        cardlink_bill_id: bill.bill_id,
        payment_url: bill.payment_url,
      })
      .eq('id', order.id);
    
    // Track payment_redirect event
    await supabase.from('events').insert({
      event_type: 'payment_redirect',
      session_id: validatedData.sessionId,
      event_data: {
        order_id: order.id,
        payment_url: bill.payment_url,
        amount: validatedData.price,
      },
      ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip'),
      user_agent: request.headers.get('user-agent'),
    });
    
    return NextResponse.json({
      orderId: order.id,
      paymentUrl: bill.payment_url,
      billId: bill.bill_id,
    });
  } catch (error) {
    console.error('Order creation error:', error);
    return NextResponse.json(
      { error: 'Failed to create order' },
      { status: 500 }
    );
  }
}
```

#### `POST /api/webhooks/cardlink` - Cardlink webhook

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç Cardlink (payment success/failure)

**Request Body (–æ—Ç Cardlink):**
```json
{
  "bill_id": "bill_abc123",
  "status": "PAID",
  "amount": 75.00,
  "currency": "USD",
  "signature": "hash..."
}
```

**–õ–æ–≥–∏–∫–∞ (–∫—Ä–∏—Ç–∏—á–Ω–æ!):**
1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏** (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
2. **–ò–¥emp–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** (–ø—Ä–æ–≤–µ—Ä–∫–∞ processed_at)
3. **–õ–æ–≥ –≤ webhook_logs**
4. **–ü–æ–∏—Å–∫ payment –∏ order**
5. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–µ** –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–¥–∞:
   - `SELECT ... FOR UPDATE` (lock row)
   - `UPDATE gift_codes SET status='sold' WHERE status='available'`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `rows_affected = 1`
6. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ order.status = 'paid'**
7. **–û—Ç–ø—Ä–∞–≤–∫–∞ email** —Å –∫–æ–¥–æ–º
8. **–ó–∞–ø–∏—Å—å —Å–æ–±—ã—Ç–∏–π**: `payment_success`, `code_sent`
9. **–ê–ª–µ—Ä—Ç—ã** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–ö–æ–¥:**
```typescript
// src/app/api/webhooks/cardlink/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { cardlinkAPI } from '@/lib/cardlink/api';
import { sendOrderConfirmationEmail } from '@/lib/email/send';

export async function POST(request: NextRequest) {
  const startTime = Date.now();
  
  try {
    const body = await request.json();
    const supabase = await createClient();
    
    // Log webhook
    const { data: webhookLog } = await supabase
      .from('webhook_logs')
      .insert({
        source: 'cardlink',
        event_type: 'payment.callback',
        request_body: body,
      })
      .select()
      .single();
    
    // Verify signature
    const isValid = cardlinkAPI.verifyPostbackSignature(body);
    if (!isValid) {
      await supabase
        .from('webhook_logs')
        .update({
          processed: false,
          error: 'Invalid signature',
        })
        .eq('id', webhookLog.id);
      
      return NextResponse.json({ error: 'Invalid signature' }, { status: 401 });
    }
    
    const { bill_id, status } = body;
    
    // Find payment
    const { data: payment } = await supabase
      .from('payments')
      .select('*, orders(*)')
      .eq('bill_id', bill_id)
      .single();
    
    if (!payment) {
      return NextResponse.json({ error: 'Payment not found' }, { status: 404 });
    }
    
    // Idempotency check
    if (payment.processed_at) {
      console.log('Already processed:', payment.id);
      return NextResponse.json({ message: 'Already processed' });
    }
    
    // Generate idempotency key
    const idempotencyKey = `${bill_id}_${status}_${Date.now()}`;
    
    // Update payment
    await supabase
      .from('payments')
      .update({
        status: status.toLowerCase(),
        processed_at: new Date().toISOString(),
        idempotency_key: idempotencyKey,
        cardlink_response: body,
      })
      .eq('id', payment.id);
    
    if (status === 'PAID') {
      // Get order items
      const { data: orderItems } = await supabase
        .from('order_items')
        .select('*')
        .eq('order_id', payment.order_id);
      
      // Assign codes (TRANSACTIONAL!)
      for (const item of orderItems || []) {
        // Try to assign a code
        const { data: assignedCodes, error: assignError } = await supabase
          .from('gift_codes')
          .update({
            status: 'sold',
            order_item_id: item.id,
            sold_at: new Date().toISOString(),
          })
          .eq('product_id', item.product_id)
          .eq('nominal', item.nominal)
          .eq('status', 'available')
          .is('order_item_id', null)
          .limit(1)
          .select();
        
        if (!assignedCodes || assignedCodes.length === 0) {
          // NO CODE AVAILABLE!
          console.error('No code available for:', item.product_id, item.nominal);
          
          // Mark order as manual_review
          await supabase
            .from('orders')
            .update({ status: 'manual_review' })
            .eq('id', payment.order_id);
          
          // Create critical alert
          await supabase.from('system_notifications').insert({
            type: 'no_codes_available',
            severity: 'critical',
            title: 'No Gift Codes Available',
            message: `Order ${payment.order_id} paid but no codes available for ${item.product_name}`,
            data: { order_id: payment.order_id, product_id: item.product_id },
          });
          
          return NextResponse.json({ error: 'No codes available' }, { status: 500 });
        }
        
        // Update order_item with code
        await supabase
          .from('order_items')
          .update({ gift_code_id: assignedCodes[0].id })
          .eq('id', item.id);
      }
      
      // Update order status
      await supabase
        .from('orders')
        .update({
          status: 'paid',
          paid_at: new Date().toISOString(),
        })
        .eq('id', payment.order_id);
      
      // Track payment_success event
      await supabase.from('events').insert({
        event_type: 'payment_success',
        session_id: payment.orders.session_id,
        event_data: {
          order_id: payment.order_id,
          amount: payment.amount,
          bill_id: bill_id,
        },
      });
      
      // Send email with codes
      try {
        await sendOrderConfirmationEmail(payment.order_id);
        
        // Track code_sent event
        await supabase.from('events').insert({
          event_type: 'code_sent',
          session_id: payment.orders.session_id,
          event_data: {
            order_id: payment.order_id,
            codes_count: orderItems?.length || 0,
          },
        });
        
        // Update email status
        await supabase
          .from('orders')
          .update({
            email_status: 'sent',
            email_sent_at: new Date().toISOString(),
          })
          .eq('id', payment.order_id);
      } catch (emailError) {
        console.error('Email send error:', emailError);
        
        // Update email status
        await supabase
          .from('orders')
          .update({
            email_status: 'failed',
            email_retry_count: 0,
          })
          .eq('id', payment.order_id);
        
        // Create alert
        await supabase.from('system_notifications').insert({
          type: 'failed_email',
          severity: 'critical',
          title: 'Failed to Send Order Email',
          message: `Order ${payment.order_id} paid but email failed`,
          data: { order_id: payment.order_id, error: emailError.message },
        });
      }
    }
    
    // Update webhook log
    const processingTime = Date.now() - startTime;
    await supabase
      .from('webhook_logs')
      .update({
        processed: true,
        processing_time_ms: processingTime,
      })
      .eq('id', webhookLog.id);
    
    // Record health metric
    await supabase.from('system_health_metrics').insert({
      metric_type: 'webhook_latency',
      metric_value: processingTime,
    });
    
    return NextResponse.json({ message: 'Webhook processed' });
  } catch (error) {
    console.error('Webhook processing error:', error);
    return NextResponse.json(
      { error: 'Failed to process webhook' },
      { status: 500 }
    );
  }
}
```

#### `POST /api/events` - Tracking —Å–æ–±—ã—Ç–∏–π

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–∏—ë–º client-side —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

**Request:**
```json
{
  "event_type": "add_to_cart",
  "session_id": "sess_abc123",
  "visitor_id": "visitor_xyz",
  "url": "https://site.com/product/123",
  "referrer": "https://google.com",
  "utm_source": "facebook",
  "utm_campaign": "black_friday",
  "data": {
    "product_id": "uuid",
    "nominal": 100,
    "price": 75
  },
  "device_type": "mobile"
}
```

**Response:**
```json
{
  "success": true,
  "eventId": "event-uuid-123"
}
```

**–ö–æ–¥:**
```typescript
// src/app/api/events/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { z } from 'zod';

const eventSchema = z.object({
  event_type: z.string(),
  session_id: z.string(),
  visitor_id: z.string().optional(),
  url: z.string().url().optional(),
  referrer: z.string().optional(),
  utm_source: z.string().optional(),
  utm_medium: z.string().optional(),
  utm_campaign: z.string().optional(),
  utm_content: z.string().optional(),
  utm_term: z.string().optional(),
  data: z.record(z.any()).optional(),
  session_duration: z.number().optional(),
  page_duration: z.number().optional(),
  scroll_depth: z.number().optional(),
  device_type: z.string().optional(),
  country: z.string().optional(),
  city: z.string().optional(),
});

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const validatedData = eventSchema.parse(body);
    
    const supabase = await createClient();
    
    // Insert event
    const { data: event, error } = await supabase
      .from('events')
      .insert({
        ...validatedData,
        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip'),
        user_agent: request.headers.get('user-agent'),
      })
      .select()
      .single();
    
    if (error) throw error;
    
    return NextResponse.json({
      success: true,
      eventId: event.id,
    });
  } catch (error) {
    console.error('Event tracking error:', error);
    return NextResponse.json(
      { error: 'Failed to track event' },
      { status: 500 }
    );
  }
}
```

### ADMIN API

#### `POST /api/admin/codes/import` - –ò–º–ø–æ—Ä—Ç –∫–æ–¥–æ–≤ (CSV)

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç gift codes —á–µ—Ä–µ–∑ CSV

**Request (multipart/form-data):**
```
file: codes.csv
```

**CSV Format:**
```csv
code,nominal,product_id,cost_price
XXXX-XXXX-XXXX-0001,100,uuid-1,75.00
XXXX-XXXX-XXXX-0002,100,uuid-1,75.00
XXXX-XXXX-XXXX-0003,50,uuid-1,37.50
```

**Response:**
```json
{
  "success": true,
  "imported": 150,
  "skipped": 2,
  "errors": ["Duplicate code: XXXX-XXXX-XXXX-0001"]
}
```

**–ö–æ–¥:**
```typescript
// src/app/api/admin/codes/import/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import Papa from 'papaparse';

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData();
    const file = formData.get('file') as File;
    
    if (!file) {
      return NextResponse.json({ error: 'No file provided' }, { status: 400 });
    }
    
    const text = await file.text();
    const { data: rows } = Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
    });
    
    const supabase = await createClient();
    
    let imported = 0;
    let skipped = 0;
    const errors: string[] = [];
    
    const batchId = `import_${Date.now()}`;
    
    for (const row of rows as any[]) {
      try {
        // Validate row
        if (!row.code || !row.nominal || !row.product_id) {
          errors.push(`Invalid row: ${JSON.stringify(row)}`);
          skipped++;
          continue;
        }
        
        // Calculate margin
        const nominal = parseFloat(row.nominal);
        const costPrice = row.cost_price ? parseFloat(row.cost_price) : null;
        const marginPercentage = costPrice 
          ? ((nominal - costPrice) / nominal * 100) 
          : null;
        
        // Insert code
        const { error } = await supabase.from('gift_codes').insert({
          product_id: row.product_id,
          code: row.code,  // TODO: Encrypt!
          nominal: nominal,
          cost_price: costPrice,
          margin_percentage: marginPercentage,
          currency: row.currency || 'USD',
          status: 'available',
          batch_id: batchId,
        });
        
        if (error) {
          if (error.code === '23505') {
            // Duplicate
            errors.push(`Duplicate code: ${row.code}`);
            skipped++;
          } else {
            throw error;
          }
        } else {
          imported++;
        }
      } catch (rowError) {
        errors.push(`Error processing row: ${rowError.message}`);
        skipped++;
      }
    }
    
    return NextResponse.json({
      success: true,
      imported,
      skipped,
      errors,
      batchId,
    });
  } catch (error) {
    console.error('Import error:', error);
    return NextResponse.json(
      { error: 'Failed to import codes' },
      { status: 500 }
    );
  }
}
```

### AI COPILOT API

#### `POST /api/ai/copilot` - AI Business Assistant

**–û–ø–∏—Å–∞–Ω–∏–µ:** Natural language ‚Üí SQL ‚Üí Insights

**Request:**
```json
{
  "query": "Show me revenue for last 7 days"
}
```

**Response:**
```json
{
  "query": "Show me revenue for last 7 days",
  "intent": "revenue",
  "result": {
    "type": "metric",
    "metric": "Revenue",
    "value": 15234.50,
    "period": "Last 7 days",
    "formatted": "$15,234.50"
  },
  "responseTime": 125
}
```

**Supported Intents:**
- `revenue` - Revenue queries
- `profit` - Profit queries
- `top_products` - Best selling products
- `top_customers` - VIP customers
- `channels` - Marketing channels
- `alerts` - Current anomalies
- `unit_economics` - CAC, LTV, ROI

[–ö–æ–¥ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω –≤—ã—à–µ]

### PARTNER API

#### `GET /api/partners/stats` - Partner Statistics

**–û–ø–∏—Å–∞–Ω–∏–µ:** API –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç API key)

**Headers:**
```
X-API-Key: pk_live_abc123xyz
```

**Query Params:**
```
?start_date=2025-01-01&end_date=2025-01-31
```

**Response:**
```json
{
  "partner": {
    "id": "uuid",
    "name": "Partner Name",
    "commission_rate": 10
  },
  "period": {
    "start": "2025-01-01",
    "end": "2025-01-31"
  },
  "stats": {
    "total_orders": 50,
    "total_revenue": 5000.00,
    "total_commission": 500.00,
    "avg_order_value": 100.00,
    "total_clicks": 1000,
    "total_conversions": 50,
    "conversion_rate": 5.0,
    "pending_payout": 500.00
  },
  "links": [
    {
      "code": "SPECIAL10",
      "clicks": 500,
      "conversions": 25,
      "revenue": 2500.00,
      "commission": 250.00
    }
  ]
}
```

[–ö–æ–¥ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω –≤—ã—à–µ]

---

## üìä –ê–î–ú–ò–ù –î–ê–®–ë–û–†–î–´ (–í–°–ï 19)

### 1. üìä Overview (`/admin`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- Total revenue (today, 7d, 30d)
- Total orders (today, 7d, 30d)
- Conversion rate trend
- Top products
- Recent orders
- Quick stats cards

**Key Metrics:**
```typescript
// Revenue cards
const todayRevenue = SUM(orders.total_amount WHERE status='paid' AND DATE(created_at) = TODAY)
const weekRevenue = SUM(orders.total_amount WHERE status='paid' AND created_at >= NOW() - 7 days)
const monthRevenue = SUM(orders.total_amount WHERE status='paid' AND created_at >= NOW() - 30 days)

// Orders
const todayOrders = COUNT(orders WHERE status='paid' AND DATE(created_at) = TODAY)
const weekOrders = COUNT(orders WHERE status='paid' AND created_at >= NOW() - 7 days)

// CR
const conversionRate = (paid_orders / total_sessions * 100)
```

### 2. ü§ñ AI Copilot (`/admin/copilot`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- Interactive chat interface
- Example queries
- Real-time AI responses
- Query history with results

**Features:**
- Natural language queries
- Metric cards
- Tables
- Alerts
- Charts (future)

**Example Queries:**
```
"Show me revenue for last 7 days"
"What's our profit this week?"
"Who are our best customers?"
"Show top 10 products"
"What are the top performing channels?"
```

### 3. ‚ö° Real-time (`/admin/realtime`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- Live metrics (auto-refresh every 30s)
- Today's stats
- Recent orders (last 20)
- Event distribution
- Active sessions

**Metrics:**
```typescript
// Today stats
const today = {
  sessions: COUNT(DISTINCT events.session_id WHERE DATE(created_at) = TODAY),
  orders: COUNT(orders WHERE status='paid' AND DATE(created_at) = TODAY),
  revenue: SUM(orders.total_amount WHERE status='paid' AND DATE(created_at) = TODAY),
  conversionRate: (orders / sessions * 100)
}

// Recent orders (real-time)
const recentOrders = SELECT * FROM orders 
  ORDER BY created_at DESC 
  LIMIT 20
```

### 4. üß† BI Insights (`/admin/insights`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- Automated insights & anomalies
- Revenue & profit trends
- LTV by cohort
- Predictive forecasts

**Data Sources:**
- `detect_anomalies()` - Automated alerts
- `get_ltv_by_cohort()` - Cohort analysis
- `daily_metrics` - Trend calculations

**Features:**
- Anomaly cards (critical/warning/info)
- Trend graphs
- Cohort table
- Key insights

### 5. üíé Unit Economics (`/admin/unit-economics`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- True profit waterfall
- AOV, CAC, LTV
- LTV/CAC ratio
- Automated recommendations

**Profit Waterfall:**
```
Revenue:               $15,000
‚àí Cost of Goods:       $11,250
= Gross Profit:        $3,750  (25% margin)
‚àí Transaction Fees:    $450    (3%)
‚àí Refunds:             $150    (1%)
‚àí Ad Spend:            $1,500
= True Profit:         $1,650  (11% margin)
```

**Customer Economics:**
```
AOV: $100.00
CAC: $10.00
LTV: $100.00
LTV/CAC Ratio: 10.00x  (Excellent!)
```

### 6. üí∞ Financial (`/admin/financial`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- ROI by channel
- Profit by channel
- MER (Marketing Efficiency Ratio)
- Ad spend tracking

**Data Source:** `get_channel_stats_financial()`

**Table:**
```
Channel      | Orders | Revenue  | Profit  | Ad Spend | ROI    | MER
Facebook     | 200    | $15,000  | $3,750  | $1,000   | 275%   | 15.0
Google       | 100    | $7,500   | $1,875  | $800     | 134%   | 9.4
Direct       | 50     | $3,750   | $937    | $0       | -      | -
```

### 7. üìä RFM Segments (`/admin/rfm`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- 7 customer segments
- Segment distribution
- Customer list with RFM scores
- Marketing recommendations

**Segments:**
1. VIP Champions (R‚â•4, F‚â•4, M‚â•4)
2. Loyal Customers (F‚â•4)
3. Big Spenders (M‚â•4)
4. At Risk (R‚â§2, F‚â•3)
5. Promising (R‚â•4, F‚â§2)
6. Need Attention (R=3, F=3)
7. Lost (R‚â§2, F‚â§2)

**Data Source:** `get_rfm_segments()`

### 8. üì¶ Orders (`/admin/orders`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- All orders with filters
- Order details
- Payment status
- Email delivery status
- Actions (resend email, manual review)

**Filters:**
- Status (all, paid, pending, failed)
- Date range
- Email search
- Amount range

### 9. üéüÔ∏è Codes (`/admin/codes`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- Gift codes inventory
- Available/sold/reserved counts
- CSV import
- Stock alerts
- Filter by product/nominal

**Features:**
- CSV import with validation
- Batch operations
- Low stock alerts (<10 codes)

### 10. üè∑Ô∏è Products (`/admin/products`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- Product CRUD
- Pricing & discounts
- Stock status
- Sales stats per product

**Actions:**
- Create new product
- Edit product (inline)
- Activate/deactivate
- View sales stats

### 11. ü§ù Partners (`/admin/partners`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- Partner accounts
- Performance stats
- Commission tracking
- API documentation

**Metrics per Partner:**
- Total orders
- Revenue generated
- Commission earned
- Clicks & conversion rate

### 12. üîî Alerts (`/admin/alerts`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- System notifications
- Low stock alerts
- Failed emails
- Pending payments
- Critical issues

**Types:**
- `low_stock` - Less than 10 codes
- `failed_email` - Email delivery failed
- `pending_payment` - Payment pending >2h
- `no_codes_available` - Critical!

**Actions:**
- Mark as resolved
- View details
- Take action (resend email, etc)

### 13. üîÑ Funnel (`/admin/funnel`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- Conversion funnel
- Drop-off rates
- Bottlenecks identification

**Data Source:** `get_funnel_stats()`

**Steps:**
1. Page View (100%)
2. Product View (50%)
3. Add to Cart (10%)
4. Checkout Start (5%)
5. Payment (2%)

**Visualization:**
- Bar chart with percentages
- Conversion rates between steps
- Identify biggest drop-offs

### 14. üì¢ Channels (`/admin/channels`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- Marketing channel performance
- ROI by channel
- Budget allocation recommendations

**Data Source:** `get_channel_stats_financial()`

**Features:**
- ROI sorting
- Spend tracking
- MER calculations
- Recommendations

### 15. üë• Cohorts (`/admin/cohorts`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- LTV by cohort (monthly)
- Retention rates
- Repeat purchase behavior

**Data Source:** `get_ltv_by_cohort()`

**Table:**
```
Cohort    | Customers | Avg LTV | Repeat Rate | Avg Orders
2025-01   | 150       | $100    | 25%         | 1.35
2024-12   | 200       | $110    | 30%         | 1.45
```

### 16. üìß CRM (`/admin/crm`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- Abandoned checkouts
- Winback candidates
- Campaign opportunities
- Email triggers

**Data Sources:**
- `get_abandoned_checkouts()` - Last 6 hours
- `get_winback_candidates()` - Last 30 days

**Actions:**
- Send recovery email
- Create campaign
- Manual outreach

### 17. üîç Data Quality (`/admin/data-quality`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- Data health score
- Missing data checks
- Anomalies detection
- SQL functions health

**Checks:**
- Orders without session_id
- Orders without UTM
- Events orphaned
- Conversion funnel integrity

### 18. üè• Health (`/admin/health`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- System uptime (%)
- Performance metrics
- Webhook latency
- Email send time
- Failed emails list

**Data Source:** `get_system_health()`

**Metrics:**
```
Uptime: 99.95%
Webhook latency: 125ms (target <1000ms)
Email send time: 850ms (target <2000ms)
Critical issues: 0
```

### 19. üîó Webhooks (`/admin/webhooks`)

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- Webhook logs
- Request/response details
- Processing times
- Error tracking

**Table:**
```
Time      | Source    | Event Type       | Order ID | Status  | Duration
10:30:15  | Cardlink  | payment.success  | order-1  | Success | 125ms
10:29:42  | Cardlink  | payment.success  | order-2  | Success | 98ms
```

---

## üéØ –ü–û–õ–ù–´–ô FLOW –ê–ù–ê–õ–ò–¢–ò–ö–ò

### User Journey —Å Tracking

```
1. Landing (utm_source=facebook, utm_campaign=black_friday)
   ‚îú‚îÄ> Cookie: lv_sess (session_id)
   ‚îú‚îÄ> Cookie: lv_visitor (visitor_id)
   ‚îú‚îÄ> LocalStorage: utm_* (Last Non-Direct Click)
   ‚îî‚îÄ> Event: page_view
       {
         "event_type": "page_view",
         "session_id": "sess_abc123",
         "visitor_id": "visitor_xyz",
         "url": "https://site.com/",
         "utm_source": "facebook",
         "utm_campaign": "black_friday"
       }

2. Browse Catalog
   ‚îî‚îÄ> Event: view_catalog
       {
         "event_type": "view_catalog",
         "session_id": "sess_abc123",
         "data": { "filters": {...} }
       }

3. Click Product
   ‚îî‚îÄ> Event: view_product
       {
         "event_type": "view_product",
         "session_id": "sess_abc123",
         "data": {
           "product_id": "uuid-1",
           "brand": "Amazon",
           "nominal": 100
         }
       }

4. Configure Product
   ‚îú‚îÄ> Event: configurator_open
   ‚îî‚îÄ> Event: configurator_change (on every change)
       {
         "event_type": "configurator_change",
         "data": {
           "product_id": "uuid-1",
           "nominal": 100,
           "delivery_type": "myself"
         }
       }

5. Add to Cart
   ‚îî‚îÄ> Event: add_to_cart
       {
         "event_type": "add_to_cart",
         "data": {
           "product_id": "uuid-1",
           "nominal": 100,
           "price": 75.00
         }
       }

6. Checkout Start
   ‚îî‚îÄ> Event: checkout_start
       {
         "event_type": "checkout_start",
         "session_id": "sess_abc123"
       }

7. Checkout Submit
   ‚îú‚îÄ> Event: checkout_submit
   ‚îî‚îÄ> API: POST /api/orders/create
       {
         "productId": "uuid-1",
         "nominal": 100,
         "price": 75.00,
         "email": "customer@example.com",
         "sessionId": "sess_abc123",
         "utm": {
           "utm_source": "facebook",
           "utm_campaign": "black_friday"
         }
       }
       
       Response: { "paymentUrl": "...", "orderId": "..." }

8. Payment Redirect
   ‚îú‚îÄ> Event: payment_redirect (server-side)
   ‚îî‚îÄ> Redirect to Cardlink

9. Payment on Cardlink
   ‚îî‚îÄ> User completes payment

10. Cardlink Webhook
    ‚îî‚îÄ> POST /api/webhooks/cardlink
        {
          "bill_id": "bill_abc123",
          "status": "PAID"
        }
        
        Process:
        ‚îú‚îÄ> Find order
        ‚îú‚îÄ> Assign gift code (transactional)
        ‚îú‚îÄ> Update order.status = 'paid'
        ‚îú‚îÄ> Send email with code
        ‚îú‚îÄ> Event: payment_success (server-side)
        ‚îî‚îÄ> Event: code_sent (server-side)

11. Return to Site
    ‚îú‚îÄ> URL: /success?orderId=xxx
    ‚îî‚îÄ> Event: payment_return
        {
          "event_type": "payment_return",
          "data": {
            "order_id": "order-uuid",
            "status": "success"
          }
        }

12. View Order in Account
    ‚îî‚îÄ> User can see order history, download codes
```

### Data Flow

```
CLIENT-SIDE EVENTS
   ‚îÇ
   ‚îú‚îÄ> JavaScript: Analytics.trackEvent()
   ‚îÇ      ‚Üì
   ‚îú‚îÄ> POST /api/events
   ‚îÇ      ‚Üì
   ‚îî‚îÄ> Supabase: INSERT INTO events

SERVER-SIDE EVENTS
   ‚îÇ
   ‚îú‚îÄ> Order creation
   ‚îú‚îÄ> Webhook processing
   ‚îú‚îÄ> Email sending
   ‚îÇ      ‚Üì
   ‚îî‚îÄ> Direct INSERT INTO events

ANALYTICS PROCESSING
   ‚îÇ
   ‚îú‚îÄ> Materialized View: daily_metrics
   ‚îÇ   (Refreshed via cron: REFRESH MATERIALIZED VIEW)
   ‚îÇ      ‚Üì
   ‚îú‚îÄ> SQL Functions:
   ‚îÇ   ‚îú‚îÄ> get_funnel_stats()
   ‚îÇ   ‚îú‚îÄ> get_channel_stats_financial()
   ‚îÇ   ‚îú‚îÄ> get_ltv_by_cohort()
   ‚îÇ   ‚îú‚îÄ> detect_anomalies()
   ‚îÇ   ‚îî‚îÄ> get_unit_economics()
   ‚îÇ      ‚Üì
   ‚îî‚îÄ> Admin Dashboards
       ‚îú‚îÄ> Real-time
       ‚îú‚îÄ> Funnel
       ‚îú‚îÄ> Channels
       ‚îú‚îÄ> Cohorts
       ‚îú‚îÄ> Financial
       ‚îî‚îÄ> Insights
```

---

## üîå –ò–ù–¢–ï–ì–†–ê–¶–ò–ò

### 1. Cardlink Payment API

**Base URL:** `https://api.cardlink.com/v2`

**Authentication:**
```typescript
const headers = {
  'Authorization': `Bearer ${CARDLINK_API_KEY}`,
  'Content-Type': 'application/json'
}
```

**Create Bill:**
```typescript
POST /bill/create
{
  "amount": 75.00,
  "currency": "USD",
  "order_id": "order-uuid",
  "customer_email": "customer@example.com",
  "return_url": "https://yoursite.com/pending?orderId=xxx",
  "webhook_url": "https://yoursite.com/api/webhooks/cardlink",
  "expires_in": 3600  // 1 hour
}

Response:
{
  "bill_id": "bill_abc123",
  "payment_url": "https://cardlink.com/pay/bill_abc123",
  "expires_at": "2025-01-15T11:30:00Z"
}
```

**Get Bill Status:**
```typescript
GET /bill/status?bill_id=bill_abc123

Response:
{
  "bill_id": "bill_abc123",
  "status": "PAID",  // or "PENDING", "EXPIRED", "FAILED"
  "amount": 75.00,
  "paid_at": "2025-01-15T10:35:42Z"
}
```

**Webhook Signature Verification:**
```typescript
function verifyPostbackSignature(body: any): boolean {
  const { signature, ...data } = body;
  
  // Sort keys alphabetically
  const keys = Object.keys(data).sort();
  const signatureString = keys.map(key => `${key}=${data[key]}`).join('&');
  
  // Add secret
  const stringToHash = signatureString + CARDLINK_SECRET;
  
  // SHA-256 hash
  const expectedSignature = crypto
    .createHash('sha256')
    .update(stringToHash)
    .digest('hex');
  
  return signature === expectedSignature;
}
```

### 2. Google Analytics 4 (GA4)

**Installation:**
```html
<!-- In app/layout.tsx -->
<Script
  id="google-analytics"
  strategy="afterInteractive"
  dangerouslySetInnerHTML={{
    __html: `
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', '${GA4_MEASUREMENT_ID}', {
        page_path: window.location.pathname,
      });
    `,
  }}
/>
<Script
  strategy="afterInteractive"
  src={`https://www.googletagmanager.com/gtag/js?id=${GA4_MEASUREMENT_ID}`}
/>
```

**E-commerce Events:**
```typescript
// View Item
gtag('event', 'view_item', {
  currency: 'USD',
  value: 75.00,
  items: [{
    item_id: 'uuid-1',
    item_name: 'Amazon Gift Card',
    item_brand: 'Amazon',
    price: 75.00,
    quantity: 1
  }]
});

// Add to Cart
gtag('event', 'add_to_cart', {
  currency: 'USD',
  value: 75.00,
  items: [...]
});

// Begin Checkout
gtag('event', 'begin_checkout', {
  currency: 'USD',
  value: 75.00,
  items: [...]
});

// Purchase
gtag('event', 'purchase', {
  transaction_id: 'order-uuid',
  value: 75.00,
  currency: 'USD',
  items: [...]
});
```

### 3. Meta Pixel

**Installation:**
```html
<!-- In app/layout.tsx -->
<Script
  id="meta-pixel"
  strategy="afterInteractive"
  dangerouslySetInnerHTML={{
    __html: `
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '${META_PIXEL_ID}');
      fbq('track', 'PageView');
    `,
  }}
/>
```

**Events:**
```typescript
// View Content
fbq('track', 'ViewContent', {
  content_ids: ['uuid-1'],
  content_type: 'product',
  value: 75.00,
  currency: 'USD'
});

// Add to Cart
fbq('track', 'AddToCart', {
  content_ids: ['uuid-1'],
  content_type: 'product',
  value: 75.00,
  currency: 'USD'
});

// Initiate Checkout
fbq('track', 'InitiateCheckout', {
  content_ids: ['uuid-1'],
  content_type: 'product',
  value: 75.00,
  currency: 'USD'
});

// Purchase
fbq('track', 'Purchase', {
  value: 75.00,
  currency: 'USD',
  content_ids: ['uuid-1'],
  content_type: 'product'
});
```

### 4. Email (SMTP / Mailgun / AWS SES)

**Configuration:**
```typescript
// .env.local
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=noreply@yoursite.com
SMTP_PASSWORD=your_password
SMTP_FROM=Lonieve Gift <noreply@yoursite.com>

// Or Mailgun
MAILGUN_API_KEY=key-xxx
MAILGUN_DOMAIN=mg.yoursite.com
```

**Send Email:**
```typescript
// Using nodemailer
import nodemailer from 'nodemailer';

const transporter = nodemailer.createTransport({
  host: process.env.SMTP_HOST,
  port: process.env.SMTP_PORT,
  secure: false,
  auth: {
    user: process.env.SMTP_USER,
    pass: process.env.SMTP_PASSWORD,
  },
});

await transporter.sendMail({
  from: process.env.SMTP_FROM,
  to: 'customer@example.com',
  subject: 'Your Gift Cards Are Ready!',
  html: orderConfirmationEmailTemplate(order, codes),
  text: orderConfirmationEmailTextTemplate(order, codes),
});
```

**Email Template:**
```html
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; }
    .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; }
    .header { background: #0A0A0A; color: #D4AF37; padding: 20px; text-align: center; }
    .code-box { background: #f9f9f9; border: 2px dashed #D4AF37; padding: 15px; margin: 15px 0; text-align: center; }
    .code { font-size: 24px; font-weight: bold; letter-spacing: 2px; color: #0A0A0A; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéÅ Your Gift Cards Are Ready!</h1>
    </div>
    
    <p>Hi {{customerName}},</p>
    
    <p>Thank you for your purchase! Your gift card codes are below:</p>
    
    {{#each codes}}
    <div class="code-box">
      <div><strong>{{productName}}</strong></div>
      <div class="code">{{code}}</div>
      <div>Value: ${{nominal}}</div>
    </div>
    {{/each}}
    
    <p><strong>How to redeem:</strong></p>
    <ol>
      <li>Go to the retailer's website</li>
      <li>Enter your code at checkout</li>
      <li>Enjoy your purchase!</li>
    </ol>
    
    <p>Order ID: {{orderId}}</p>
    <p>Order Date: {{orderDate}}</p>
    
    <p>Need help? Contact us at support@yoursite.com</p>
    
    <p>Best regards,<br>Lonieve Gift Team</p>
  </div>
</body>
</html>
```

---

## üöÄ DEPLOYMENT

### Vercel (Frontend)

**1. Install Vercel CLI:**
```bash
npm i -g vercel
```

**2. Login:**
```bash
vercel login
```

**3. Deploy:**
```bash
vercel --prod
```

**Environment Variables:**
```
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx
NEXT_PUBLIC_GA4_MEASUREMENT_ID=G-XXXXXXXXXX
NEXT_PUBLIC_META_PIXEL_ID=123456789
NEXT_PUBLIC_SITE_URL=https://yoursite.com

# Server-side only
SUPABASE_SERVICE_ROLE_KEY=eyJyyy
CARDLINK_API_KEY=xxx
CARDLINK_SECRET=xxx
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=xxx
SMTP_PASSWORD=xxx
```

**vercel.json:**
```json
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "nextjs",
  "regions": ["iad1"],
  "env": {
    "NEXT_PUBLIC_SUPABASE_URL": "@supabase_url",
    "NEXT_PUBLIC_SUPABASE_ANON_KEY": "@supabase_anon_key"
  }
}
```

### Supabase (Backend)

**1. Create Project:**
- Go to https://supabase.com
- Create new project
- Note URL and keys

**2. Run Migrations:**
```bash
# In Supabase Dashboard ‚Üí SQL Editor
# Copy/paste each migration file:
20240101000000_initial_schema.sql
20240101000001_seed_data.sql
20240102000000_critical_improvements.sql
20240103000000_deep_analytics.sql
20240104000000_financial_analytics.sql
20240105000000_business_intelligence.sql
20240106000000_intelligence_hub.sql
```

**3. Enable RLS:**
```sql
-- Already in migrations
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE order_items ENABLE ROW LEVEL SECURITY;
-- etc...
```

**4. Setup Edge Functions (for cron jobs):**
```bash
# Install Supabase CLI
npm i -g supabase

# Login
supabase login

# Deploy function
supabase functions deploy refresh-analytics

# Schedule (in Supabase Dashboard ‚Üí Database ‚Üí Extensions ‚Üí pg_cron)
SELECT cron.schedule(
  'refresh-daily-metrics',
  '0 1 * * *',  -- Every day at 1 AM
  $$
  REFRESH MATERIALIZED VIEW CONCURRENTLY daily_metrics;
  $$
);
```

### Custom Domain

**1. Add domain in Vercel:**
- Project ‚Üí Settings ‚Üí Domains
- Add your domain: `yoursite.com`

**2. DNS Settings (Cloudflare/Namecheap):**
```
Type  | Name | Value
A     | @    | 76.76.21.21
CNAME | www  | cname.vercel-dns.com
```

**3. SSL:**
- Automatic via Vercel (Let's Encrypt)

---

## üí° –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø

### Example 1: –ü–æ–ª–Ω—ã–π Purchase Flow

```typescript
// 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç "Buy Now"
const handleBuyClick = async () => {
  // Track event
  Analytics.addToCart(productId, nominal, price);
  
  // Save config to sessionStorage
  sessionStorage.setItem('checkout_config', JSON.stringify({
    productId,
    nominal,
    price,
    deliveryType: 'myself',
  }));
  
  // Redirect to checkout
  router.push('/checkout');
};

// 2. Checkout Page
const CheckoutPage = () => {
  const config = JSON.parse(sessionStorage.getItem('checkout_config'));
  
  // Track checkout start
  useEffect(() => {
    Analytics.checkoutStart();
  }, []);
  
  const handleCheckout = async () => {
    // Track checkout submit
    Analytics.checkoutSubmit(config.productId, config.price);
    
    // Create order
    const response = await fetch('/api/orders/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        ...config,
        email: formData.email,
        firstName: formData.firstName,
        lastName: formData.lastName,
        sessionId: getSessionId(),
        utm: getUTMParams(),
      }),
    });
    
    const { paymentUrl } = await response.json();
    
    // Redirect to payment
    window.location.href = paymentUrl;
  };
  
  return (/* Checkout form */);
};

// 3. Cardlink processes payment ‚Üí webhook
// (Server-side, automatic)

// 4. Success page
const SuccessPage = () => {
  const { orderId } = useSearchParams();
  
  useEffect(() => {
    Analytics.paymentReturn(orderId, 'success');
  }, [orderId]);
  
  return (/* Thank you message */);
};
```

### Example 2: Admin - Import Codes

```typescript
// Admin page
const ImportCodesPage = () => {
  const [file, setFile] = useState(null);
  
  const handleImport = async () => {
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('/api/admin/codes/import', {
      method: 'POST',
      body: formData,
    });
    
    const result = await response.json();
    
    alert(`Imported: ${result.imported}, Skipped: ${result.skipped}`);
  };
  
  return (
    <div>
      <input
        type="file"
        accept=".csv"
        onChange={(e) => setFile(e.target.files[0])}
      />
      <button onClick={handleImport}>Import Codes</button>
    </div>
  );
};
```

### Example 3: AI Copilot Query

```typescript
// Copilot page
const CopilotPage = () => {
  const [query, setQuery] = useState('');
  const [result, setResult] = useState(null);
  
  const handleQuery = async () => {
    const response = await fetch('/api/ai/copilot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query }),
    });
    
    const data = await response.json();
    setResult(data);
  };
  
  return (
    <div>
      <input
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        placeholder="Ask anything about your business..."
      />
      <button onClick={handleQuery}>Ask</button>
      
      {result && result.result.type === 'metric' && (
        <div>
          <h3>{result.result.metric}</h3>
          <p>{result.result.formatted}</p>
          <small>{result.result.period}</small>
        </div>
      )}
    </div>
  );
};
```

### Example 4: Partner API Usage

```bash
# Partner –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ API
curl -X GET "https://yoursite.com/api/partners/stats?start_date=2025-01-01&end_date=2025-01-31" \
  -H "X-API-Key: pk_live_abc123xyz"

# Response:
{
  "partner": {
    "id": "uuid",
    "name": "Partner Name",
    "commission_rate": 10
  },
  "stats": {
    "total_orders": 50,
    "total_revenue": 5000.00,
    "total_commission": 500.00,
    "conversion_rate": 5.0
  }
}
```

### Example 5: Abandoned Cart Recovery

```typescript
// Cron job (runs every 6 hours)
const processAbandonedCarts = async () => {
  const supabase = await createClient();
  
  // Get abandoned checkouts
  const { data: abandoned } = await supabase.rpc('get_abandoned_checkouts', {
    minutes_ago: 360,  // 6 hours
  });
  
  for (const checkout of abandoned) {
    // Check if already sent
    const { data: existing } = await supabase
      .from('campaign_logs')
      .select('*')
      .eq('recipient_email', checkout.email)
      .eq('campaign_type', 'abandoned_cart')
      .gte('sent_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())
      .single();
    
    if (existing) continue;  // Already sent today
    
    // Send recovery email
    await sendAbandonedCartEmail(checkout);
    
    // Log campaign
    await supabase.from('campaign_logs').insert({
      campaign_type: 'abandoned_cart',
      recipient_email: checkout.email,
      subject: 'You left something behind! üõí',
      status: 'sent',
    });
  }
};
```

---

## üéä –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê

### –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

**–ö–æ–¥:**
- **300+ —Ñ–∞–π–ª–æ–≤**
- **7 –º–∏–≥—Ä–∞—Ü–∏–π –ë–î** (–ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã)
- **19 –∞–¥–º–∏–Ω –¥–∞—à–±–æ—Ä–¥–æ–≤** (–∫–∞–∂–¥—ã–π —Å unique —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º)
- **20+ SQL —Ñ—É–Ω–∫—Ü–∏–π** (–ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã)
- **30+ API endpoints** (REST + webhooks)
- **75,000+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞**

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- **40+ —Ç–∞–±–ª–∏—Ü** (—Å indexes, RLS, triggers)
- **90+ –∏–Ω–¥–µ–∫—Å–æ–≤** (–¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
- **5 materialized views** (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
- **15+ triggers** (–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è)
- **20+ SQL —Ñ—É–Ω–∫—Ü–∏–π** (business logic)

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ E-commerce (gift cards)
- ‚úÖ Payments (Cardlink integration)
- ‚úÖ Deep Analytics (12 events, full funnel)
- ‚úÖ Financial Analytics (ROI, Profit, Margin)
- ‚úÖ Business Intelligence (anomalies, forecasts)
- ‚úÖ AI Copilot (natural language queries)
- ‚úÖ Unit Economics (CAC, LTV, True Profit)
- ‚úÖ RFM Segmentation (7 customer segments)
- ‚úÖ Email Orchestrator (campaigns, attribution)
- ‚úÖ Social Proof (reviews, purchase counters)
- ‚úÖ Behavioral Analytics (session, scroll, device)
- ‚úÖ Health Monitoring (uptime, performance)
- ‚úÖ Partner API (affiliate program)
- ‚úÖ Jobs Engine (automation)
- ‚úÖ Telegram Ready (bot infrastructure)
- ‚úÖ Multi-tenant (multiple domains)
- ‚úÖ A/B Testing (experiments framework)
- ‚úÖ CRM Automation (abandoned cart, winback)
- ‚úÖ Data Quality (monitoring, alerts)

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**
- ‚úÖ Cardlink (payments)
- ‚úÖ GA4 (analytics)
- ‚úÖ Meta Pixel (ads)
- ‚úÖ Email (SMTP/Mailgun/SES)
- ‚úÖ Telegram Bot (ready)

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- Session tracking: 30 days
- Visitor tracking: 365 days
- Webhook latency: <1000ms
- Email send time: <2000ms
- Page load: <2s
- API response: <500ms
- Database queries: optimized —Å indexes

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ RLS policies (row-level security)
- ‚úÖ Webhook signature verification
- ‚úÖ API key authentication
- ‚úÖ Idempotency –¥–ª—è webhooks
- ‚úÖ Transaction safety
- ‚úÖ Code encryption (TODO)
- ‚úÖ Rate limiting (TODO)

**–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- Multi-tenant support
- Materialized views
- Optimized indexes
- Cron jobs
- Edge functions
- CDN ready

---

## üèÜ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**Lonieve Gift - —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –º–∞–≥–∞–∑–∏–Ω, —ç—Ç–æ:**

üè¢ **Enterprise BI Platform** - –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞  
ü§ñ **AI-Powered Assistant** - –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∑–∞ 10 —Å–µ–∫—É–Ω–¥  
üíé **Unit Economics Engine** - –∏—Å—Ç–∏–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å  
üìä **RFM Marketing Machine** - 7 —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤  
ü§ù **Affiliate Marketplace** - –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è —Å–µ—Ç—å  
üìÖ **Automation Hub** - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∞–º–æ  
üì≤ **Mobile Control Ready** - Telegram bot  
üè• **Health Monitoring** - 99.9% uptime  

**–ì–û–¢–û–í–û –ö –ú–ê–°–®–¢–ê–ë–£ $1M+ ARR!** üöÄüíéü§ñ

---

**Version: 4.0 (Intelligence Hub Edition)**  
**Date: January 2025**  
**Status: PRODUCTION-READY ‚úÖ**  
**Documentation: COMPLETE 100%**  

**–≠—Ç–æ—Ç –≥–∞–π–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç:**
- ‚úÖ –ü–æ–ª–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- ‚úÖ –í—Å–µ 40+ —Ç–∞–±–ª–∏—Ü —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- ‚úÖ –í—Å–µ 20+ SQL —Ñ—É–Ω–∫—Ü–∏–π —Å –∫–æ–¥–æ–º
- ‚úÖ –í—Å–µ 30+ API endpoints —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- ‚úÖ –í—Å–µ 19 –∞–¥–º–∏–Ω –¥–∞—à–±–æ—Ä–¥–æ–≤
- ‚úÖ –ü–æ–ª–Ω—ã–π flow –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- ‚úÖ –í—Å–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- ‚úÖ Deployment –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–ì–û–¢–û–í–û –ö –ó–ê–ü–£–°–ö–£! –ú–û–ñ–ù–û –ó–ê–†–ê–ë–ê–¢–´–í–ê–¢–¨!** üí∞üéâüèÜ

